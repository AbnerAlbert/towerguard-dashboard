<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>TowerGuard Pro – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','-apple-system','Segoe UI','Roboto','Arial','sans-serif'],
          },
        },
      },
    };
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />

  <style>
    html, body { height: 100%; }
    body {
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: #e5e7eb;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
    }
    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.06), transparent 55%), rgba(15,23,42,0.96);
      border-radius: 1rem;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 20px 40px rgba(15,23,42,0.8);
    }
    .chip {
      border-radius: 999px;
      padding: 0.15rem 0.7rem;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .badge-dot {
      width: 0.6rem;
      height: 0.6rem;
      border-radius: 999px;
    }
    .pulse {
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(52,211,153,0.4); }
      70%  { box-shadow: 0 0 0 10px rgba(52,211,153,0); }
      100% { box-shadow: 0 0 0 0 rgba(52,211,153,0); }
    }
    .toast {
      position: fixed;
      right: 1.5rem;
      bottom: 1.5rem;
      background: rgba(16,185,129,0.12);
      color: #bbf7d0;
      border: 1px solid rgba(16,185,129,0.4);
      padding: 0.8rem 1.3rem;
      border-radius: 999px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      opacity: 0;
      transform: translateY(10px);
      transition: all .25s ease-out;
      pointer-events: none;
      z-index: 50;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .sidebar-item-active {
      background: linear-gradient(to right, rgba(37,99,235,0.4), transparent);
      border-color: rgba(96,165,250,0.9);
      color: #e5e7eb;
    }
    .sidebar-item {
      transition: all .2s ease-out;
    }
    .sidebar-item:hover {
      background-color: rgba(15,23,42,0.85);
    }
    .page-section {
      display: none;
    }
    .page-section.active {
      display: block;
    }
  
    /* ARGUS (modal) */
    .tg-modal{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; }
    .tg-modal.hidden{ display:none; }
    .tg-modal__backdrop{ position:absolute; inset:0; background:rgba(2,6,23,.78); backdrop-filter: blur(10px); }
    .tg-modal__panel{
      position:relative; width:min(980px, calc(100vw - 28px)); height:min(640px, calc(100vh - 28px));
      border-radius: 20px;
      border:1px solid rgba(148,163,184,.18);
      background: radial-gradient(1200px 600px at 20% 10%, rgba(124,58,237,.18), transparent 50%),
                  radial-gradient(900px 500px at 80% 30%, rgba(14,165,233,.14), transparent 55%),
                  rgba(2,6,23,.78);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .tg-modal__header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; padding:18px 18px 10px; }
    .tg-modal__kicker{ font-size:11px; letter-spacing:.22em; text-transform:uppercase; color:rgba(148,163,184,.9); }
    .tg-modal__title{ font-size:18px; font-weight:800; color:rgba(226,232,240,1); margin-top:2px; }
    .tg-modal__sub{ font-size:12px; color:rgba(148,163,184,.95); margin-top:4px; max-width:720px; }
    .tg-icon-btn{ width:34px; height:34px; border-radius:999px; border:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.55); color:rgba(226,232,240,1); }
    .tg-icon-btn:hover{ background:rgba(2,6,23,.78); }
    .tg-modal__suggest{ padding:0 18px 12px; font-size:12px; color:rgba(148,163,184,.95); }
    .tg-chat{ padding:0 18px 16px; height: calc(100% - 118px); display:flex; flex-direction:column; gap:12px; }
    .tg-thread{ flex:1; overflow:auto; border-radius:16px; border:1px solid rgba(148,163,184,.14); background:rgba(2,6,23,.35); padding:14px; }
    .tg-msg{ max-width:82%; padding:10px 12px; border-radius:16px; border:1px solid rgba(148,163,184,.14); margin:8px 0; }
    .tg-msg--user{ margin-left:auto; background:rgba(37,99,235,.18); }
    .tg-msg--argus{ background:rgba(124,58,237,.12); }
    .tg-msg__meta{ font-size:11px; color:rgba(148,163,184,.9); margin-bottom:4px; }
    .tg-msg__text{ font-size:13px; color:rgba(226,232,240,1); line-height:1.35; white-space:pre-wrap; }
    .tg-inputbar{ display:flex; gap:10px; }
    .tg-input{
      flex:1; height:44px; border-radius:14px; padding:0 14px;
      border:1px solid rgba(148,163,184,.16); background:rgba(2,6,23,.55); color:rgba(226,232,240,1);
      outline:none;
    }
    .tg-input:focus{ border-color: rgba(124,58,237,.55); box-shadow: 0 0 0 4px rgba(124,58,237,.18); }
    .tg-send{
      height:44px; padding:0 16px; border-radius:14px;
      border:1px solid rgba(124,58,237,.35); background:rgba(124,58,237,.75); color:white; font-weight:700;
    }
    .tg-send:hover{ background:rgba(124,58,237,.95); }
    .tg-footnote{ font-size:11px; color:rgba(148,163,184,.9); }

  
    /* ARGUS chips (card) */
    .tg-chip{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.45);
      color: rgba(226,232,240,1);
    }
    .tg-chip:hover{ background: rgba(2,6,23,.70); }

  </style>

<style>
/* ================= MOBILE ENTERPRISE MODE ================= */
@media (max-width: 768px) {

  body {
    font-size: 15px;
  }

  /* Stack layout */
  main {
    display: flex !important;
    flex-direction: column !important;
    gap: 12px;
  }

  /* Cards full width */
  .glass, .card, .panel {
    width: 100% !important;
  }

  /* Hide heavy graphs by default */
  .desktop-only {
    display: none !important;
  }

  /* Timeline collapsible */
  .timeline {
    max-height: 220px;
    overflow-y: auto;
  }

  /* ARGUS dock button */
  #argusDockBtn {
    position: fixed;
    bottom: 16px;
    right: 16px;
    z-index: 9999;
    background: #0f172a;
    color: #fff;
    border-radius: 999px;
    padding: 14px 18px;
    font-weight: 600;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  /* ARGUS modal full screen */
  #argusModal {
    position: fixed !important;
    inset: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    border-radius: 0 !important;
    z-index: 10000 !important;
  }
}
</style>

</head>
<body class="dark">
  <div class="h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-950/95 border-r border-slate-800 flex flex-col">
      <!-- Topo com logo -->
      <div class="px-4 py-4 flex items-center gap-3 border-b border-slate-800">
        <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-blue-500 to-sky-400 flex items-center justify-center shadow-lg shadow-blue-500/40">
          <i class="fa-solid fa-tower-cell text-xl text-white"></i>
        </div>
        <div>
          <p class="text-[0.60rem] uppercase tracking-[0.30em] text-slate-500">TowerGuard</p>
          <p class="text-sm font-semibold tracking-tight text-slate-100">
            Command Center <span class="text-blue-400">Pro</span>
          </p>
          <p class="text-[0.65rem] text-slate-500">Enterprise Edition</p>
        </div>
      </div>

      <!-- Menu -->
      <nav class="flex-1 px-3 py-4 space-y-1 text-sm">
        <button data-page-target="dashboard" class="sidebar-item sidebar-item-active w-full flex items-center gap-2 px-3 py-2 rounded-lg border border-transparent text-slate-200 text-left">
          <i class="fa-solid fa-chart-line text-sky-400 w-5"></i>
          Dashboard
        </button>
        <button data-page-target="reports" class="sidebar-item w-full flex items-center gap-2 px-3 py-2 rounded-lg border border-transparent text-slate-300 text-left">
          <i class="fa-solid fa-file-lines text-emerald-400 w-5"></i>
          Relatórios
        </button>
        <button data-page-target="register" class="sidebar-item w-full flex items-center gap-2 px-3 py-2 rounded-lg border border-transparent text-slate-300 text-left">
          <i class="fa-solid fa-plus-circle text-blue-300 w-5"></i>
          Cadastro de Sites
        </button>
        <button data-page-target="map" class="sidebar-item w-full flex items-center gap-2 px-3 py-2 rounded-lg border border-transparent text-slate-300 text-left">
          <i class="fa-solid fa-location-dot text-amber-300 w-5"></i>
          Mapa
        </button>
      </nav>

      <!-- Usuário + Sair -->
      <div class="px-3 py-3 border-t border-slate-800 flex items-center justify-between text-xs text-slate-400">
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-full bg-slate-800 flex items-center justify-center text-[0.7rem] text-slate-200">
            AA
          </div>
          <div>
            <p class="font-semibold text-slate-200 text-[0.78rem]">Abner Albert</p>
            <p class="text-[0.65rem] text-slate-500">Operador NOC</p>
          </div>
        </div>
        <button id="btnLogout" class="chip bg-red-900/40 border border-red-500/50 text-red-300 flex items-center gap-1">
          <i class="fa-solid fa-right-from-bracket"></i>
          Sair
        </button>
      </div>
    </aside>

    <!-- MAIN AREA -->
    <div class="flex-1 flex flex-col">
      <!-- HEADER -->
      <header class="h-16 px-6 border-b border-slate-800 flex items-center justify-between bg-slate-950/80 backdrop-blur">
        <div class="flex items-center gap-4">
          <div>
            <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Site Monitorado</p>
            <div class="flex items-center gap-2">
              <select id="siteSelect" class="bg-slate-900/90 border border-slate-700 text-xs rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-blue-500"></select>
              <span id="siteIsoBadge" class="chip bg-slate-900/80 border border-slate-700 text-slate-300 flex items-center gap-1">
                <span class="badge-dot bg-blue-500"></span>
                <span id="isoText">ISO 9223</span>
              </span>
            </div>
          </div>

          <div id="connBadge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-900/30 border border-emerald-500/50 text-xs text-emerald-300">
            <span class="badge-dot bg-emerald-400 pulse"></span>
            <span id="connText">Gateway Online</span>
          </div>
        </div>

        <div class="flex items-center gap-4 text-xs text-slate-400">
          <div class="hidden md:flex items-center gap-2">
            <i class="fa-solid fa-clock text-slate-500"></i>
            <span id="clockLabel">--:--:--</span>
          </div>

          <div class="hidden md:flex items-center gap-2">
            <span class="text-[0.70rem] text-slate-500">Cenário:</span>
            <select id="scenarioSelect" class="bg-slate-900/90 border border-slate-700 text-xs rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="default">Padrão</option>
              <option value="coastal">Costeiro Severo</option>
              <option value="urban">Urbano Costeiro</option>
              <option value="inland">Interior Seco</option>
            </select>
          </div>

          <button id="btnSim" class="px-3 py-1.5 rounded-full bg-blue-600 hover:bg-blue-500 text-xs font-semibold shadow shadow-blue-500/40">
            Iniciar Simulação
          </button>
          <button id="btnPresent" class="px-3 py-1.5 rounded-full bg-amber-500/90 hover:bg-amber-400 text-xs font-semibold text-slate-900">
            Modo Executivo <span class="ml-2 px-2 py-0.5 rounded-full text-[11px] font-semibold bg-amber-500/20 text-amber-200 border border-amber-400/30">Modo: Demonstração</span>
          </button>

          <button id="btnArgus" class="px-3 py-1.5 rounded-full bg-violet-500/80 hover:bg-violet-500 text-xs font-semibold shadow shadow-violet-500/40">
            ARGUS Copiloto
          </button>

        </div>
      </header>

      <!-- CONTENT -->
      <main class="flex-1 overflow-auto bg-slate-950/80 p-5 space-y-4">

        <!-- PAGE: DASHBOARD -->
        <section id="page-dashboard" class="page-section active space-y-4">
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
            <!-- Col 1 -->
            <div class="xl:col-span-2 space-y-4">
              <div class="card p-4">
                <div class="flex flex-wrap justify-between gap-4 items-center">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Resumo do Site</p>
                    <h2 id="siteTitle" class="text-lg font-semibold text-slate-100">--</h2>
                    <p id="siteSubtitle" class="text-xs text-slate-400">--</p>
                  </div>
                  <div class="flex gap-6 xl:gap-10">
                    <div class="text-right">
                      <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Categoria ISO 9223</p>
                      <p id="isoLabel" class="text-2xl font-bold text-blue-400">--</p>
                      <p class="text-[0.70rem] text-slate-500">Ambiente de corrosividade</p>
                    </div>
                    <div class="text-right">
                      <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Vida Útil Prot. Zinco</p>
                      <p id="rulLabel" class="text-2xl font-bold text-emerald-400">--</p>
                      <p class="text-[0.70rem] text-slate-500">Estimativa até limite crítico</p>
                    </div>
                    <div class="text-right">
                      <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Índice de Integridade</p>
                      <p id="iisLabel" class="text-2xl font-bold text-violet-400">--/100</p>
                      <p class="text-[0.70rem] text-slate-500">Composto (Zinco, Aço, ambiente)</p>
                    </div>
                  </div>
                </div>

                <!-- Widgets de região / clima -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4">
                  <div class="bg-slate-900/80 rounded-xl p-3 text-xs">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Região</p>
                    <p id="regionLabel" class="text-sm font-semibold text-slate-100">--</p>
                  </div>
                  <div class="bg-slate-900/80 rounded-xl p-3 text-xs">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Umidade do ar</p>
                    <p id="humidityLabel" class="text-sm font-semibold text-sky-300">--%</p>
                  </div>
                  <div class="bg-slate-900/80 rounded-xl p-3 text-xs">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Vento</p>
                    <p id="windLabel" class="text-sm font-semibold text-emerald-300">-- km/h</p>
                  </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4">
                  <!-- Sensor Cu -->
                  <div class="bg-slate-900/90 rounded-xl p-3 border border-slate-700/70">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Sensor Sacrificial (Cobre)</p>
                    <p id="cuValueLabel" class="text-xl font-bold text-sky-400 mb-1">-- mV</p>
                    <div class="grid grid-cols-2 gap-2 text-[0.70rem] text-slate-300">
                      <div>
                        <p class="text-slate-400">Bateria</p>
                        <p><span id="cuBatteryLabel" class="text-emerald-400">--%</span></p>
                        <div class="w-full bg-slate-800 rounded-full h-1.5 mt-1 overflow-hidden">
                          <div id="cuBatteryBar" class="h-1.5 rounded-full bg-gradient-to-r from-emerald-400 to-lime-300" style="width:0%"></div>
                        </div>
                        <p id="cuBatteryLife" class="text-[0.65rem] text-slate-500 mt-1">-- dias restantes</p>
                      </div>
                      <div>
                        <p class="text-slate-400">Dano da Placa</p>
                        <p><span id="cuDamageLabel" class="text-amber-300">--%</span></p>
                        <div class="w-full bg-slate-800 rounded-full h-1.5 mt-1 overflow-hidden">
                          <div id="cuDamageBar" class="h-1.5 rounded-full bg-gradient-to-r from-amber-400 to-red-500" style="width:0%"></div>
                        </div>
                        <p id="cuDamageLife" class="text-[0.65rem] text-slate-500 mt-1">Vida restante: --%</p>
                      </div>
                    </div>
                  </div>

                  <!-- Zinco -->
                  <div class="bg-slate-900/90 rounded-xl p-3 border border-slate-700/70">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Proteção (Zinco)</p>
                    <p class="text-xl font-bold">
                      <span id="zincLevelLabel" class="text-emerald-400">--%</span>
                    </p>
                    <div class="w-full bg-slate-800 rounded-full h-1.5 mt-1 overflow-hidden">
                      <div id="zincBar" class="h-1.5 rounded-full bg-gradient-to-r from-emerald-400 to-lime-400" style="width:0%"></div>
                    </div>
                    <p class="text-[0.70rem] text-slate-500 mt-1">
                      Limite crítico: <span class="text-emerald-300">100%</span>
                    </p>
                  </div>

                  <!-- Aço -->
                  <div class="bg-slate-900/90 rounded-xl p-3 border border-slate-700/70">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Dano em Estrutura (Aço)</p>
                    <p class="text-xl font-bold">
                      <span id="steelLevelLabel" class="text-amber-300">--%</span>
                    </p>
                    <div class="w-full bg-slate-800 rounded-full h-1.5 mt-1 overflow-hidden">
                      <div id="steelBar" class="h-1.5 rounded-full bg-gradient-to-r from-amber-400 to-red-500" style="width:0%"></div>
                    </div>
                    <p class="text-[0.70rem] text-slate-500 mt-1">
                      Limite de alerta: <span class="text-orange-300">30%</span>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Gráfico -->
              <div class="card p-4">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Histórico</p>
                    <h3 class="text-sm font-semibold text-slate-100">Tendência de Corrosão (simulação)</h3>
                  </div>
                  <div class="flex gap-2 text-[0.65rem] text-slate-400">
                    <span class="inline-flex items-center gap-1">
                      <span class="w-3 h-0.5 bg-sky-400 inline-block"></span>Cu
                    </span>
                    <span class="inline-flex items-center gap-1">
                      <span class="w-3 h-0.5 bg-emerald-400 inline-block"></span>Zinco
                    </span>
                    <span class="inline-flex items-center gap-1">
                      <span class="w-3 h-0.5 bg-orange-400 inline-block"></span>Aço
                    </span>
                  </div>
                </div>
                <div class="h-64">
                  <canvas id="mainChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Col 2 -->
            <div class="space-y-4">
              <!-- Ranking -->
              <div class="card p-4 h-[230px] flex flex-col">
                <div class="flex justify-between items-center mb-2">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500">Parque Monitorado</p>
                    <h3 class="text-sm font-semibold text-slate-100">Ranking de Risco</h3>
                  </div>
                  <span class="chip bg-slate-900/80 border border-slate-600/60 text-slate-300 flex items-center gap-1">
                    <i class="fa-solid fa-fire-flame-curved text-orange-400"></i>Prioridade
                  </span>
                </div>
                <div class="flex-1 overflow-auto">
                  <table class="w-full text-xs text-slate-300">
                    <thead class="text-[0.65rem] uppercase tracking-[0.12em] text-slate-500 border-b border-slate-800">
                      <tr>
                        <th class="py-1 text-left">Site</th>
                        <th class="py-1 text-right">Zinco</th>
                        <th class="py-1 text-right">Aço</th>
                        <th class="py-1 text-right">Risco</th>
                      </tr>
                    </thead>
                    <tbody id="riskTableBody"></tbody>
                  </table>
                </div>
              </div>

              <!-- Timeline de eventos -->
              <div class="card p-4 h-[180px] flex flex-col">
                <div class="flex justify-between items-center mb-2">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500">Eventos Recentes</p>
                    <h3 class="text-sm font-semibold text-slate-100">Timeline Operacional</h3>
                  </div>
                  <span class="chip bg-slate-900/80 border border-slate-700 text-slate-300 flex items-center gap-1">
                    <i class="fa-solid fa-stream text-sky-400"></i>Log
                  </span>
                </div>
                <div id="timelineList" class="flex-1 overflow-auto text-xs text-slate-300"></div>
              </div>

              <!-- Manutenção -->
              <div class="card p-4 space-y-3">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.2em] text-slate-500">Ação Recomendada</p>
                    <h3 class="text-sm font-semibold text-slate-100">Janela de Manutenção Preditiva</h3>
                  </div>
                  <div id="maintBadge" class="chip bg-emerald-900/40 border border-emerald-500/40 text-emerald-300 flex items-center gap-1">
                    <span class="badge-dot bg-emerald-400"></span>Saudável
                  </div>
                </div>
                <p id="maintText" class="text-xs text-slate-300">
                  Nenhum limite crítico atingido para o site atual. Sistema em monitoramento contínuo.
                </p>

                <div class="mt-1 text-[0.70rem] text-slate-300 space-y-1">
                  <p class="text-slate-400 font-semibold">Tempo Estimado até Falha (simulação)</p>
                  <p>Sensor Cu: <span id="tefCu" class="text-sky-300">--</span></p>
                  <p>Proteção Zinco: <span id="tefZinc" class="text-emerald-300">--</span></p>
                  <p>Estrutura Aço: <span id="tefSteel" class="text-orange-300">--</span></p>
                </div>

                <button id="btnMaint" class="w-full mt-1 flex items-center justify-center gap-2 text-xs font-semibold px-3 py-2 rounded-xl bg-slate-800 border border-slate-600/70 text-slate-100 hover:bg-red-600 hover:border-red-400 hover:text-white transition disabled:opacity-40 disabled:cursor-not-allowed" disabled>
                  <i class="fa-solid fa-screwdriver-wrench"></i>
                  Acionar Manutenção
                </button>
                <p class="text-[0.65rem] text-slate-500">
                  Botão habilitado automaticamente quando o <span class="text-emerald-300">Zinco atinge o limite crítico</span> ou o
                  <span class="text-orange-300">dano em Aço ultrapassa o limite de alerta</span>.
                </p>
              </div>

              <!-- Gateway -->
              <div class="card p-4 space-y-2">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.2em] text-slate-500">Gateway Solar 4G</p>
                    <h3 class="text-sm font-semibold text-slate-100">Status do Campo</h3>
                  </div>
                  <div id="gwStatusPill" class="chip bg-emerald-900/40 border border-emerald-500/60 text-emerald-300 flex items-center gap-1">
                    <span class="badge-dot bg-emerald-400 pulse"></span>Online
                  </div>
                </div>
                <div class="grid grid-cols-3 gap-3 text-xs text-slate-300">
                  <div>
                    <p class="text-slate-400">Sinal LoRaWAN</p>
                    <p id="gwSignalLabel" class="font-semibold text-sky-300">-- dBm</p>
                  </div>
                  <div>
                    <p class="text-slate-400">Bateria Gateway</p>
                    <p id="gwBatteryLabel" class="font-semibold text-emerald-300">--%</p>
                  </div>
                  <div>
                    <p class="text-slate-400">Última Comunicação</p>
                    <p id="gwLastSeen" class="font-semibold text-slate-200">agora</p>
                  </div>
                </div>
              </div>

              <!-- Custo evitado -->
              <div class="card p-4 space-y-2">
                <p class="text-[0.65rem] uppercase tracking-[0.2em] text-slate-500">Impacto Financeiro Estimado</p>
                <div class="flex items-end justify-between">
                  <div>
                    <p class="text-xs text-slate-400">Custos de falhas evitados (simulação)</p>
                    <p id="costLabel" class="text-xl font-bold text-emerald-400">R$ 0</p>
                  </div>
                  <div class="w-28 h-2 bg-slate-900 rounded-full overflow-hidden">
                    <div id="costBar" class="h-2 rounded-full bg-gradient-to-r from-emerald-400 to-amber-400" style="width:0%"></div>
                  </div>
                </div>
                <p class="text-[0.65rem] text-slate-500">
                  Estimativa baseada em inspeções evitadas e substituições de estrutura não realizadas (modelo fictício para uso acadêmico).
                </p>
              </div>
            </div>
          </div>
        </section>

      <!-- ARGUS (CARD FIXO) -->
      <div class="glass rounded-2xl p-4 mt-4" id="argusCard">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-[0.2em] text-slate-400">ARGUS</div>
            

      <!-- CENÁRIOS (DEMO) -->
      <div class="glass rounded-2xl p-4 mt-4" id="demoScenarioCard">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-[0.2em] text-slate-400">Cenário (Demonstração)</div>
            <div class="text-sm font-semibold text-slate-100 mt-1">Controle de ambiente</div>
            <div class="text-xs text-slate-400 mt-1">Use para conduzir o demo: umidade/vento e impacto no risco.</div>
          </div>
        </div>

        <select id="demoScenario" class="tg-input mt-3">
          <option value="normal">Normal</option>
          <option value="agressivo">Ambiente agressivo</option>
          <option value="calor">Onda de calor</option>
          <option value="maresia">Maresia severa</option>
          <option value="tempestade">Pós-tempestade</option>
        </select>

        <div class="mt-3 flex flex-wrap gap-2">
          <button id="demoEventHumidity" class="tg-chip">Provocar: Umidade ↑</button>
          <button id="demoEventDryWet" class="tg-chip">Provocar: Ciclo seco–úmido</button>
          <button id="demoEventCritical" class="tg-chip">Provocar: Alerta crítico</button>
        </div>

        <div class="mt-2 text-[11px] text-slate-500">Ajustes de demo não representam leituras reais de campo.</div>
      </div>

<div class="flex items-center gap-2"><div class="text-base font-extrabold text-slate-100">Copiloto</div><span id="argusInsightBadge" class="hidden px-2 py-0.5 rounded-full text-[11px] font-semibold bg-emerald-500/15 text-emerald-200 border border-emerald-400/20">Insight novo</span></div>
            <div class="text-xs text-slate-400 mt-1">Pergunte sobre o ativo selecionado: risco, VUE, ambiente e plano de ação.</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="argusExpand" class="px-3 py-1.5 rounded-full bg-slate-800/60 hover:bg-slate-800 text-xs font-semibold border border-slate-600/30">
              Expandir
            </button>
          </div>
        </div>

        <div class="mt-3 rounded-2xl soft overflow-hidden border border-slate-600/15">
          <div id="argusMiniThread" class="p-3" style="height:140px; overflow:auto;"></div>
        </div>

        <div class="mt-3 flex gap-2">
          <input id="argusMiniInput" class="tg-input" placeholder="Pergunte ao ARGUS..." />
          <button id="argusMiniSend" class="tg-send" style="height:44px;">Enviar</button>
        </div>

        <div class="mt-2 flex flex-wrap gap-2">
          <button class="tg-chip" data-argusq="por que o risco subiu?">Por quê</button>
          <button class="tg-chip" data-argusq="quando devo agir?">Quando agir</button>
          <button class="tg-chip" data-argusq="resumo 24h">Resumo 24h</button>
          <button class="tg-chip" data-argusq="plano de ação">Plano de ação</button>
        </div>

        <div class="mt-2 text-[11px] text-slate-500">ARGUS usa apenas estados calculados pelo TowerGuard (sem inventar dados).</div>
      </div>



        <!-- PAGE: RELATÓRIOS -->
        <section id="page-reports" class="page-section space-y-4">
          <div class="card p-4">
            <h2 class="text-lg font-semibold mb-1">Relatórios Operacionais</h2>
            <p class="text-sm text-slate-400 mb-4">
              Gere relatórios em PDF ou exporte dados em CSV com base no site e na simulação atual.
            </p>
            <div class="flex flex-wrap gap-3">
              <button id="btnPdf" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold flex items-center gap-2">
                <i class="fa-solid fa-file-pdf"></i>
                Gerar PDF (Resumo do Site)
              </button>
              <button id="btnCsv" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm font-semibold flex items-center gap-2">
                <i class="fa-solid fa-file-csv"></i>
                Exportar CSV (Simulação)
              </button>
            </div>
          </div>
        </section>

        <!-- PAGE: CADASTRO -->
        <section id="page-register" class="page-section space-y-4">
          <div class="card p-4 max-w-xl">
            <h2 class="text-lg font-semibold mb-1">Cadastro de Novo Site</h2>
            <p class="text-sm text-slate-400 mb-4">
              Adicione um novo local ao parque monitorado. Os dados são usados apenas na simulação local (não há backend real).
            </p>
            <form id="formRegister" class="space-y-3 text-sm">
              <div>
                <label class="block text-slate-300 mb-1">ID do Site</label>
                <input id="newId" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="EV-XX-00" required />
              </div>
              <div>
                <label class="block text-slate-300 mb-1">Nome</label>
                <input id="newName" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Descrição do local" required />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-slate-300 mb-1">Distância da orla (km)</label>
                  <input id="newDist" type="number" step="0.1" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="0.5" required />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Fator ambiente (ISO)</label>
                  <input id="newFactor" type="number" step="0.1" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="1.5" required />
                </div>
              </div>
              <button type="submit" class="mt-2 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-semibold flex items-center gap-2">
                <i class="fa-solid fa-save"></i>
                Salvar Site
              </button>
            </form>
          </div>
        </section>

        <!-- PAGE: MAPA (conceitual) -->
        <section id="page-map" class="page-section space-y-4">
          <div class="card p-4">
            <div class="flex justify-between items-center mb-3">
              <div>
                <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500">Localização do Ativo</p>
                <h2 class="text-lg font-semibold text-slate-100">Mapa Operacional (conceitual)</h2>
              </div>
              <span class="chip bg-slate-900/80 border border-slate-700 text-slate-300 flex items-center gap-1">
                <i class="fa-solid fa-location-dot text-amber-300"></i>
                Mapa
              </span>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mt-2">
              <!-- Área visual do mapa (mock) -->
              <div class="md:col-span-2 rounded-xl bg-gradient-to-br from-slate-900 via-slate-900 to-slate-800 border border-slate-700 flex items-center justify-center">
                <div class="text-center text-slate-400 text-sm px-4 py-8">
                  <i class="fa-solid fa-map-location-dot text-3xl text-blue-400 mb-3"></i>
                  <p>Visualização conceitual do site selecionado.</p>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Em produção, aqui integraríamos com Google Maps / Leaflet usando as coordenadas reais do ativo.
                  </p>
                </div>
              </div>

              <!-- Detalhes do ativo -->
              <div class="space-y-3 text-xs text-slate-300">
                <div>
                  <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Ativo</p>
                  <p id="mapSite" class="text-sm font-semibold text-slate-100">--</p>
                </div>
                <div>
                  <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Endereço (referência)</p>
                  <p id="mapAddress" class="text-[0.80rem] text-slate-300">--</p>
                </div>
                <div>
                  <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Região</p>
                  <p id="mapRegion" class="text-[0.80rem] text-slate-300">--</p>
                </div>
                <div>
                  <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Condições Ambientais</p>
                  <p id="mapEnv" class="text-[0.80rem] text-slate-300">--</p>
                </div>
                <div id="mapSummary" class="mt-2 grid gap-2 text-[0.78rem]"></div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  
  <!-- ARGUS MODAL -->
  <div id="argusModal" class="tg-modal hidden" role="dialog" aria-modal="true">
    <div class="tg-modal__backdrop" id="argusBackdrop"></div>
    <div class="tg-modal__panel">
      <div class="tg-modal__header">
        <div>
          <div class="tg-modal__kicker">ARGUS</div>
          <div class="tg-modal__title">Copiloto — respostas objetivas</div>
          <div class="tg-modal__sub">Pergunte sobre o ativo selecionado: risco, VUE, o que mudou no ambiente e planos de ação.</div>
        </div>
        <button id="argusClose" class="tg-icon-btn" title="Fechar">✕</button>
      </div>

      <div class="tg-modal__suggest">
        Sugestões: “por que o risco subiu?”, “quando devo agir?”, “resumo 24h”, “o que mudou no ambiente?”, “plano de ação”.
      </div>

      <div class="tg-chat">
        <div id="argusThread" class="tg-thread" aria-live="polite"></div>

        <div class="tg-inputbar">
          <input id="argusInput" class="tg-input" placeholder="Pergunte ao ARGUS..." />
          <button id="argusSend" class="tg-send">Enviar</button>
        </div>

        <div class="tg-footnote">ARGUS usa apenas estados calculados pelo TowerGuard (sem inventar dados).</div>
      </div>
    </div>
  </div>


  <!-- TOAST -->
  <div id="toast" class="toast">
    <i class="fa-solid fa-circle-check text-emerald-400"></i>
    <span id="toastMsg">OK</span>
  </div>

  <script>
    const sites = [
      {
        id: 'EV-BA-01',
        name: 'Salvador – Orla Atlântica',
        distKm: 0.2,
        envFactor: 1.7,
        region: 'NE',
        city: 'Salvador/BA',
        address: 'Orla Atlântica – Ponto Técnico 01',
        humidity: 78,
        wind: 16,
        sensorCu: 15,
        battery: 92,
        plateDamage: 18,
        zinc: 25,
        steel: 0,
        costSaved: 5,
        gwBattery: 97,
        gwSignal: -80
      },
      {
        id: 'EV-RJ-04',
        name: 'Rio de Janeiro – Litoral Sul',
        distKm: 0.5,
        envFactor: 1.6,
        region: 'SE',
        city: 'Rio de Janeiro/RJ',
        address: 'Zona Sul – Ponto Técnico 04',
        humidity: 75,
        wind: 18,
        sensorCu: 18,
        battery: 88,
        plateDamage: 22,
        zinc: 30,
        steel: 2,
        costSaved: 8,
        gwBattery: 94,
        gwSignal: -78
      },
      {
        id: 'EV-PE-08',
        name: 'Recife – Boa Viagem',
        distKm: 0.3,
        envFactor: 1.5,
        region: 'NE',
        city: 'Recife/PE',
        address: 'Boa Viagem – Ponto Técnico 08',
        humidity: 82,
        wind: 15,
        sensorCu: 12,
        battery: 95,
        plateDamage: 10,
        zinc: 20,
        steel: 0,
        costSaved: 3,
        gwBattery: 99,
        gwSignal: -79
      }
    ];

    const THRESHOLDS = {
      zincCritical: 100,
      zincAttention: 70,
      steelCritical: 30,
      steelAttention: 15
    };

    const RISK_LEVELS = {
      moderate: 60,
      high: 90,
      CRÍTICO: 130
    };

    const SCENARIOS = {
      default: {
        label: 'Padrão',
        corrosionMultiplier: 1.0,
        humidityDrift: 0,
        windDrift: 0
      },
      coastal: {
        label: 'Costeiro Severo',
        corrosionMultiplier: 1.6,
        humidityDrift: 4,
        windDrift: 3
      },
      urban: {
        label: 'Urbano Costeiro',
        corrosionMultiplier: 1.2,
        humidityDrift: 2,
        windDrift: 1
      },
      inland: {
        label: 'Interior Seco',
        corrosionMultiplier: 0.7,
        humidityDrift: -4,
        windDrift: -1
      }
    };

    let currentScenario = 'default';
    let currentIndex = 0;
    let mainChart = null;
    let simInterval = null;
    let eventTimeline = [];
    const MAX_EVENTS = 15;
    let stepsCounter = 0;
    let lastGwSeenSeconds = 0;

    function isoCategory(f) {
      if (f >= 1.6) return 'C5-M (Muito Alta)';
      if (f >= 1.3) return 'C4 (Alta)';
      if (f >= 1.0) return 'C3 (Média)';
      return 'C2 (Moderada)';
    }

    function calcIIS(site) {
      const zincImpact = Math.min(site.zinc, 120) / 120;
      const steelImpact = site.steel / 100;
      const envImpact = site.envFactor / 2;
      const plateImpact = site.plateDamage / 100;
      let score = 100 - (zincImpact * 35 + steelImpact * 40 + envImpact * 15 + plateImpact * 10);
      if (score < 0) score = 0;
      if (score > 100) score = 100;
      return score;
    }

    function formatBRL(thousands) {
      const v = thousands * 1000;
      return v.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        maximumFractionDigits: 0
      });
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      const span = document.getElementById('toastMsg');
      span.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    function addEvent(level, title, desc) {
      const now = new Date();
      const ts = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      eventTimeline.unshift({ ts, level, title, desc });
      if (eventTimeline.length > MAX_EVENTS) {
        eventTimeline.pop();
      }
      renderTimeline();
    }

    function renderTimeline() {
      const container = document.getElementById('timelineList');
      if (!container) return;
      container.innerHTML = '';
      eventTimeline.forEach(ev => {
        let colorClass = 'text-slate-200';
        if (ev.level === 'info') colorClass = 'text-sky-300';
        else if (ev.level === 'warn') colorClass = 'text-amber-300';
        else if (ev.level === 'CRÍTICO') colorClass = 'text-red-400';
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-start gap-2 mb-1.5';
        wrapper.innerHTML =
          '<span class="text-[0.65rem] text-slate-500 w-10 shrink-0">' + ev.ts + '</span>' +
          '<div class="flex-1">' +
            '<p class="text-[0.75rem] ' + colorClass + '">' + ev.title + '</p>' +
            '<p class="text-[0.70rem] text-slate-400">' + ev.desc + '</p>' +
          '</div>';
        container.appendChild(wrapper);
      });
    }

    function updateEnvWidgets(site) {
      document.getElementById('regionLabel').textContent =
        site.region + ' • ' + site.city;
      const demoO = (window.__DEMO_OVERRIDE__ || null);
      const humV = demoO && typeof demoO.hum === 'number' ? demoO.hum : site.humidity;
      const windV = demoO && typeof demoO.wind === 'number' ? demoO.wind : site.wind;
      document.getElementById('humidityLabel').textContent = humV.toFixed(0) + '%';
      document.getElementById('windLabel').textContent = windV.toFixed(1) + ' km/h';

      document.getElementById('mapSite').textContent =
        site.id + ' — ' + site.name;
      document.getElementById('mapAddress').textContent = site.address;
      document.getElementById('mapRegion').textContent =
        site.region + ' • ' + site.city;
      document.getElementById('mapEnv').textContent =
        'Umidade ' + site.humidity.toFixed(0) +
        '% • Vento ' + site.wind.toFixed(1) + ' km/h';
    }

    function updateHeader(site) {
      document.getElementById('siteTitle').textContent = site.id + ' — ' + site.name;
      document.getElementById('siteSubtitle').textContent =
        site.distKm.toFixed(1) + ' km da orla • Fator ' + site.envFactor.toFixed(2) + 'x';
      const iso = isoCategory(site.envFactor);
      document.getElementById('isoLabel').textContent = iso;
      document.getElementById('isoText').textContent = iso;
      const remaining = Math.max(0, THRESHOLDS.zincCritical - site.zinc);
      const days = Math.round(remaining * (site.envFactor > 1 ? 1.2 : 1.6));
      document.getElementById('rulLabel').textContent = days + ' dias';

      const iis = calcIIS(site);
      const iisLabel = document.getElementById('iisLabel');
      iisLabel.textContent = iis.toFixed(0) + '/100';
      if (iis >= 80) {
        iisLabel.className = 'text-2xl font-bold text-emerald-400';
      } else if (iis >= 50) {
        iisLabel.className = 'text-2xl font-bold text-amber-300';
      } else {
        iisLabel.className = 'text-2xl font-bold text-red-400';
      }

      updateEnvWidgets(site);
      updateMapSummary();
    }

    function updateTEF(site) {
      const sc = SCENARIOS[currentScenario] || SCENARIOS.default;
      const factor = site.envFactor * sc.corrosionMultiplier;

      function formatDays(d) {
        if (d <= 1) return '≤ 1 dia';
        if (d < 60) return Math.round(d) + ' dias';
        const months = d / 30;
        return months.toFixed(1).replace('.', ',') + ' meses';
      }

      const rateCu = Math.max(0.1, factor * 0.8);
      const rateZinc = Math.max(0.1, factor * 0.6);
      const rateSteel = Math.max(0.05, factor * 0.18);

      const dCu = site.plateDamage >= 100 ? 0 : (100 - site.plateDamage) / rateCu;
      const dZn = site.zinc >= THRESHOLDS.zincCritical ? 0 : (THRESHOLDS.zincCritical - site.zinc) / rateZinc;
      const targetSteel = THRESHOLDS.steelCritical;
      const dSt = site.steel >= targetSteel ? 0 : (targetSteel - site.steel) / rateSteel;

      document.getElementById('tefCu').textContent = formatDays(dCu);
      document.getElementById('tefZinc').textContent = formatDays(dZn);
      document.getElementById('tefSteel').textContent = formatDays(dSt);
    }

    function updateGatewayCard(site) {
      const statusPill = document.getElementById('gwStatusPill');
      const signalEl = document.getElementById('gwSignalLabel');
      const battEl = document.getElementById('gwBatteryLabel');
      const lastSeenEl = document.getElementById('gwLastSeen');

      signalEl.textContent = site.gwSignal.toFixed(0) + ' dBm';
      battEl.textContent = site.gwBattery.toFixed(0) + '%';

      if (lastGwSeenSeconds < 30) {
        statusPill.className = 'chip bg-emerald-900/40 border border-emerald-500/60 text-emerald-300 flex items-center gap-1';
        statusPill.innerHTML = '<span class="badge-dot bg-emerald-400 pulse"></span>Online';
        lastSeenEl.textContent = 'há poucos segundos';
      } else if (lastGwSeenSeconds < 180) {
        statusPill.className = 'chip bg-amber-900/40 border border-amber-400/60 text-amber-200 flex items-center gap-1';
        statusPill.innerHTML = '<span class="badge-dot bg-amber-400"></span>Intermitente';
        lastSeenEl.textContent = 'há ' + Math.round(lastGwSeenSeconds / 60) + ' min';
      } else {
        statusPill.className = 'chip bg-red-900/40 border border-red-500/60 text-red-300 flex items-center gap-1';
        statusPill.innerHTML = '<span class="badge-dot bg-red-500"></span>Offline';
        lastSeenEl.textContent = 'há ' + Math.round(lastGwSeenSeconds / 60) + ' min';
      }
    }

    function updateSensorCards(site) {
      document.getElementById('cuValueLabel').textContent = site.sensorCu.toFixed(2) + ' mV';
      document.getElementById('cuBatteryLabel').textContent = site.battery.toFixed(0) + '%';
      document.getElementById('cuBatteryBar').style.width = Math.min(100, site.battery) + '%';
      const days = Math.max(1, Math.round(site.battery * 0.4));
      document.getElementById('cuBatteryLife').textContent = '~ ' + days + ' dias restantes';

      document.getElementById('cuDamageLabel').textContent = site.plateDamage.toFixed(1) + '%';
      document.getElementById('cuDamageBar').style.width = Math.min(100, site.plateDamage) + '%';
      const remainingLife = Math.max(0, 100 - site.plateDamage);
      document.getElementById('cuDamageLife').textContent = 'Vida restante: ' + remainingLife.toFixed(0) + '%';

      document.getElementById('zincLevelLabel').textContent = site.zinc.toFixed(1) + '%';
      document.getElementById('zincBar').style.width = Math.min(100, site.zinc) + '%';

      document.getElementById('steelLevelLabel').textContent = site.steel.toFixed(1) + '%';
      const steelRatio = Math.min(100, (site.steel / THRESHOLDS.steelCritical) * 100);
      document.getElementById('steelBar').style.width = steelRatio + '%';

      document.getElementById('costLabel').textContent = formatBRL(site.costSaved);
      document.getElementById('costBar').style.width = Math.min(100, site.costSaved * 3) + '%';

      updateMaintenance(site);
      updateTEF(site);
      updateGatewayCard(site);
    }

    function updateMaintenance(site) {
      const badge = document.getElementById('maintBadge');
      const text = document.getElementById('maintText');
      const btn = document.getElementById('btnMaint');

      const zincCritical = site.zinc >= THRESHOLDS.zincCritical;
      const steelCritical = site.steel >= THRESHOLDS.steelCritical;

      if (zincCritical || steelCritical) {
        badge.className = 'chip bg-red-900/50 border border-red-500/60 text-red-300 flex items-center gap-1';
        badge.innerHTML = '<span class="badge-dot bg-red-500 pulse"></span>Crítico';
        text.textContent = 'Recomenda-se intervenção imediata: proteção de zinco esgotada e/ou dano estrutural elevado.';
        btn.disabled = false;
      } else if (site.zinc >= THRESHOLDS.zincAttention || site.steel >= THRESHOLDS.steelAttention) {
        badge.className = 'chip bg-amber-900/40 border border-amber-400/70 text-amber-200 flex items-center gap-1';
        badge.innerHTML = '<span class="badge-dot bg-amber-400"></span>Atenção';
        text.textContent = 'Janela ideal para programar manutenção preventiva antes do limite crítico.';
        btn.disabled = false;
      } else {
        badge.className = 'chip bg-emerald-900/40 border border-emerald-500/40 text-emerald-300 flex items-center gap-1';
        badge.innerHTML = '<span class="badge-dot bg-emerald-400 pulse"></span>Saudável';
        text.textContent = 'Nenhum limite crítico atingido para o site atual. Sistema em monitoramento contínuo.';
        btn.disabled = true;
      }
    }

    function riskScore(site) {
      const base = site.zinc * 0.7 + site.steel * 1.4 + site.envFactor * 10 + site.plateDamage * 0.5;
      const o = (window.__DEMO_OVERRIDE__ || null);
      const add = o && typeof o.riskDelta === 'number' ? o.riskDelta : 0;
      return base + add;
    }

    function refreshRiskTable() {
      const body = document.getElementById('riskTableBody');
      body.innerHTML = '';
      const sorted = [].concat(sites).sort(function(a, b) {
        return riskScore(b) - riskScore(a);
      });
      sorted.forEach(function(s) {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-800/60 last:border-0';
        const r = riskScore(s);
        let tag = 'Baixo';
        let cls = 'text-emerald-400';
        if (r > RISK_LEVELS.CRÍTICO) { tag = 'Crítico'; cls = 'text-red-400'; }
        else if (r > RISK_LEVELS.high) { tag = 'Alto'; cls = 'text-orange-400'; }
        else if (r > RISK_LEVELS.moderate) { tag = 'Moderado'; cls = 'text-yellow-300'; }

        tr.innerHTML =
          '<td class="py-1 text-left text-[0.72rem]">' +
            '<span class="font-semibold mr-1 text-slate-100">' + s.id + '</span>' +
            '<span class="text-slate-400">' + s.name.split('–')[0].trim() + '</span>' +
          '</td>' +
          '<td class="py-1 text-right text-[0.72rem]">' + s.zinc.toFixed(1) + '%</td>' +
          '<td class="py-1 text-right text-[0.72rem]">' + s.steel.toFixed(1) + '%</td>' +
          '<td class="py-1 text-right text-[0.72rem]">' +
            '<span class="' + cls + ' font-semibold">' + tag + '</span>' +
          '</td>';
        body.appendChild(tr);
      });
      updateMapSummary();
    }

    function updateMapSummary() {
      const container = document.getElementById('mapSummary');
      if (!container) return;

      const riskCounts = { 'Baixo': 0, 'Moderado': 0, 'Alto': 0, 'Crítico': 0 };
      const regionCounts = {};

      for (let i = 0; i < sites.length; i++) {
        const s = sites[i];
        const score = riskScore(s);
        let tag = 'Baixo';
        if (score > RISK_LEVELS.CRÍTICO) tag = 'Crítico';
        else if (score > RISK_LEVELS.high) tag = 'Alto';
        else if (score > RISK_LEVELS.moderate) tag = 'Moderado';
        riskCounts[tag] = (riskCounts[tag] || 0) + 1;
        regionCounts[s.region] = (regionCounts[s.region] || 0) + 1;
      }

      let regionHtml = '';
      for (const key in regionCounts) {
        if (Object.prototype.hasOwnProperty.call(regionCounts, key)) {
          regionHtml += '<p><span class="text-sky-300 font-semibold">' + key + ':</span> ' +
                        regionCounts[key] + ' site(s)</p>';
        }
      }

      container.innerHTML =
        '<div class="bg-slate-900/80 rounded-lg p-3 border border-slate-700/70">' +
          '<p class="text-[0.65rem] uppercase tracking-[0.18em] text-slate-500 mb-1">Distribuição por risco</p>' +
          '<div class="space-y-1 text-[0.75rem]">' +
            '<p><span class="text-emerald-400 font-semibold">Baixo:</span> ' + (riskCounts['Baixo'] || 0) + ' site(s)</p>' +
            '<p><span class="text-yellow-300 font-semibold">Moderado:</span> ' + (riskCounts['Moderado'] || 0) + ' site(s)</p>' +
            '<p><span class="text-orange-400 font-semibold">Alto:</span> ' + (riskCounts['Alto'] || 0) + ' site(s)</p>' +
            '<p><span class="text-red-400 font-semibold">Crítico:</span> ' + (riskCounts['Crítico'] || 0) + ' site(s)</p>' +
          '</div>' +
        '</div>' +
        '<div class="bg-slate-900/80 rounded-lg p-3 border border-slate-700/70">' +
          '<p class="text-[0.65rem] uppercase tracking-[0.18em] text-slate-500 mb-1">Distribuição por região</p>' +
          '<div class="space-y-1 text-[0.75rem]">' +
            regionHtml +
          '</div>' +
        '</div>';
    }

    function initChart() {
      const ctx = document.getElementById('mainChart').getContext('2d');
      mainChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: new Array(40).fill(''),
          datasets: [
            { label: 'Cu', data: new Array(40).fill(0), borderColor: '#38bdf8', borderWidth: 2, tension: 0.25, pointRadius: 0 },
            { label: 'Zinco', data: new Array(40).fill(0), borderColor: '#22c55e', borderWidth: 2, tension: 0.25, pointRadius: 0 },
            { label: 'Aço', data: new Array(40).fill(0), borderColor: '#fb923c', borderWidth: 2, tension: 0.25, pointRadius: 0 }
          ]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: {
              beginAtZero: true,
              ticks: { color: '#9ca3af', font: { size: 10 } },
              grid: { color: 'rgba(55,65,81,0.6)' }
            }
          }
        }
      });
    }

    function pushChartPoint(site) {
      if (!mainChart) return;
      const d = mainChart.data.datasets;
      d[0].data.push(site.sensorCu);
      d[1].data.push(site.zinc);
      d[2].data.push(site.steel);
      d.forEach(function(ds) { ds.data.shift(); });
      mainChart.update('none');
    }

    function stepSimulation() {
      const site = sites[currentIndex];
      const sc = SCENARIOS[currentScenario] || SCENARIOS.default;
      const base = site.envFactor * sc.corrosionMultiplier;

      const prevZ = site.zinc;
      const prevS = site.steel;
      const prevPlate = site.plateDamage;

      const deltaCu = (Math.random() * 0.8 + 0.2) * base;
      site.sensorCu += deltaCu;
      const deltaZinc = deltaCu * 0.5;
      site.zinc = Math.min(120, site.zinc + deltaZinc);
      const deltaPlate = deltaCu * 0.4;
      site.plateDamage = Math.min(100, site.plateDamage + deltaPlate);

      if (site.zinc > 80) {
        const deltaSteel = (site.zinc - 80) * 0.02 * base;
        site.steel = Math.min(100, site.steel + deltaSteel);
      }

      const deltaBat = 0.03 * base;
      site.battery = Math.max(0, site.battery - deltaBat);

      site.costSaved += 0.06 * base;

      site.humidity = Math.min(98, Math.max(45, site.humidity + (Math.random() * 4 - 2 + sc.humidityDrift * 0.05)));
      site.wind = Math.min(40, Math.max(0, site.wind + (Math.random() * 3 - 1.5 + sc.windDrift * 0.05)));

      site.gwBattery = Math.max(40, Math.min(100, site.gwBattery - (Math.random() * 0.02)));
      site.gwSignal = Math.max(-105, Math.min(-60, site.gwSignal + (Math.random() * 4 - 2)));

      lastGwSeenSeconds = 0;

      if (prevZ < THRESHOLDS.zincAttention && site.zinc >= THRESHOLDS.zincAttention && site.zinc < THRESHOLDS.zincCritical) {
        addEvent('warn', 'Zinco em atenção (' + site.id + ')', 'Proteção de zinco entrou em faixa de atenção para o site ' + site.id + '.');
      }
      if (prevZ < THRESHOLDS.zincCritical && site.zinc >= THRESHOLDS.zincCritical) {
        addEvent('CRÍTICO', 'Zinco esgotado (' + site.id + ')', 'Proteção de zinco atingiu limite crítico para o site ' + site.id + '.');
      }
      if (prevS < THRESHOLDS.steelAttention && site.steel >= THRESHOLDS.steelAttention && site.steel < THRESHOLDS.steelCritical) {
        addEvent('warn', 'Dano em aço em atenção (' + site.id + ')', 'Degradação estrutural entrou em zona de atenção.');
      }
      if (prevS < THRESHOLDS.steelCritical && site.steel >= THRESHOLDS.steelCritical) {
        addEvent('CRÍTICO', 'Dano estrutural crítico (' + site.id + ')', 'Dano em aço acima do limite crítico para o site ' + site.id + '.');
      }
      if (prevPlate < 50 && site.plateDamage >= 50) {
        addEvent('warn', 'Placa sacrificial degradada', 'Placa de sacrifício ultrapassou 50% de dano no site ' + site.id + '.');
      }

      stepsCounter++;
      if (stepsCounter % 15 === 0) {
        addEvent('info', 'Stream saudável', 'Gateway reportando dados de corrosão de forma contínua.');
      }

      updateHeader(site);
      updateSensorCards(site);
      refreshRiskTable();
      pushChartPoint(site);
    }

    function showPage(name) {
      const sections = document.querySelectorAll('.page-section');
      for (let i = 0; i < sections.length; i++) {
        sections[i].classList.remove('active');
      }
      const page = document.getElementById('page-' + name);
      if (page) page.classList.add('active');

      const buttons = document.querySelectorAll('[data-page-target]');
      for (let j = 0; j < buttons.length; j++) {
        buttons[j].classList.remove('sidebar-item-active');
      }
      const activeBtn = document.querySelector('[data-page-target="' + name + '"]');
      if (activeBtn) activeBtn.classList.add('sidebar-item-active');
    }

    function exportPdf() {
      const site = sites[currentIndex];
      const iis = calcIIS(site);
      const sc = SCENARIOS[currentScenario] || SCENARIOS.default;

      const jsPDF = window.jspdf.jsPDF;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('Relatório TowerGuard - Site ' + site.id, 14, 20);
      doc.setFontSize(11);
      doc.text('Nome: ' + site.name, 14, 32);
      doc.text('Distância da orla: ' + site.distKm.toFixed(1) + ' km', 14, 40);
      doc.text('Fator ISO: ' + site.envFactor.toFixed(2) + ' (' + isoCategory(site.envFactor) + ')', 14, 48);
      doc.text('Cenário: ' + sc.label, 14, 56);
      doc.text('Índice de Integridade: ' + iis.toFixed(0) + '/100', 14, 64);

      doc.text('Sensor Cu: ' + site.sensorCu.toFixed(2) + ' mV', 14, 76);
      doc.text('Bateria Sensor: ' + site.battery.toFixed(0) + '%', 14, 84);
      doc.text('Dano Placa: ' + site.plateDamage.toFixed(1) + '%', 14, 92);
      doc.text('Zinco: ' + site.zinc.toFixed(1) + '%', 14, 100);
      doc.text('Aço: ' + site.steel.toFixed(1) + '%', 14, 108);

      doc.text('Região: ' + site.region + ' • ' + site.city, 14, 120);
      doc.text('Umidade: ' + site.humidity.toFixed(0) + ' %', 14, 128);
      doc.text('Vento: ' + site.wind.toFixed(1) + ' km/h', 14, 136);

      doc.text('Gateway: sinal ' + site.gwSignal.toFixed(0) + ' dBm, bateria ' + site.gwBattery.toFixed(0) + '%', 14, 148);

      doc.save('towerguard_' + site.id + '.pdf');
    }

    function exportCsv() {
      const site = sites[currentIndex];
      const rows = [
        ['campo', 'valor'],
        ['site_id', site.id],
        ['nome', site.name],
        ['dist_km', site.distKm],
        ['fator_iso', site.envFactor],
        ['sensor_cu_mv', site.sensorCu],
        ['bateria_pct', site.battery],
        ['dano_placa_pct', site.plateDamage],
        ['zinco_pct', site.zinc],
        ['aco_pct', site.steel],
        ['regiao', site.region],
        ['cidade', site.city],
        ['umidade_pct', site.humidity],
        ['vento_kmh', site.wind],
        ['gw_signal_dbm', site.gwSignal],
        ['gw_bateria_pct', site.gwBattery]
      ];
      let csv = '';
      for (let i = 0; i < rows.length; i++) {
        csv += rows[i].join(';') + '\n';
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'towerguard_' + site.id + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function initSiteSelect() {
      const sel = document.getElementById('siteSelect');
      for (let i = 0; i < sites.length; i++) {
        const s = sites[i];
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = s.id + ' — ' + s.name;
        sel.appendChild(opt);
      }

      const savedIndex = localStorage.getItem('tg.currentSiteIndex');
      let initialIndex = 0;
      if (savedIndex !== null) {
        const parsed = parseInt(savedIndex, 10);
        if (!isNaN(parsed) && parsed >= 0 && parsed < sites.length) {
          initialIndex = parsed;
        }
      }

      currentIndex = initialIndex;
      sel.value = String(initialIndex);

      sel.addEventListener('change', function() {
        currentIndex = parseInt(sel.value, 10);
        if (isNaN(currentIndex) || currentIndex < 0 || currentIndex >= sites.length) {
          currentIndex = 0;
        }
        localStorage.setItem('tg.currentSiteIndex', String(currentIndex));
        const site = sites[currentIndex];
        updateHeader(site);
        updateSensorCards(site);
        refreshRiskTable();
        if (mainChart) {
          for (let i = 0; i < mainChart.data.datasets.length; i++) {
            mainChart.data.datasets[i].data = new Array(40).fill(0);
          }
          mainChart.update();
        }
        addEvent('info', 'Site alterado', 'Operador selecionou ' + site.id + ' — ' + site.name + '.');
        showToast('Site alterado para ' + site.id);
      });
    }

    function initClock() {
      const lbl = document.getElementById('clockLabel');
      function tick() {
        const d = new Date();
        lbl.textContent = d.toLocaleTimeString('pt-BR');
        lastGwSeenSeconds += 1;
        const site = sites[currentIndex];
        updateGatewayCard(site);
      }
      tick();
      setInterval(tick, 1000);
    }

    function initSidebarNav() {
      const buttons = document.querySelectorAll('[data-page-target]');
      for (let i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', function() {
          const target = buttons[i].getAttribute('data-page-target');
          showPage(target);
        });
      }
    }

    function initButtons() {
      const btnSim = document.getElementById('btnSim');
      const btnPresent = document.getElementById('btnPresent');
      const btnMaint = document.getElementById('btnMaint');
      const btnPdf = document.getElementById('btnPdf');
      const btnCsv = document.getElementById('btnCsv');
      const btnLogout = document.getElementById('btnLogout');
      const connText = document.getElementById('connText');

      btnSim.addEventListener('click', function() {
        if (simInterval) {
          clearInterval(simInterval);
          simInterval = null;
          btnSim.textContent = 'Iniciar Simulação';
          connText.textContent = 'Gateway Online (sem avanço)';
          addEvent('info', 'Simulação pausada', 'Fluxo de dados de corrosão pausado para análise.');
          showToast('Simulação pausada');
        } else {
          simInterval = setInterval(stepSimulation, 1200);
          btnSim.textContent = 'Pausar Simulação';
          connText.textContent = 'Gateway Online – stream de dados ativo';
          addEvent('info', 'Simulação iniciada', 'Fluxo de dados de corrosão em tempo real (simulado).');
          showToast('Simulação iniciada');
        }
      });

      btnPresent.addEventListener('click', function() {
        if (simInterval) clearInterval(simInterval);
        simInterval = setInterval(stepSimulation, 400);
        btnSim.textContent = 'Pausar Simulação';
        connText.textContent = 'Modo executivo – avanço acelerado';
        addEvent('info', 'Modo Executivo', 'Dashboard em modo executivo por 20 segundos para apresentação.');
        showToast('Modo Executivo por 20 segundos');
        setTimeout(function() {
          if (simInterval) {
            clearInterval(simInterval);
            simInterval = setInterval(stepSimulation, 1200);
            connText.textContent = 'Gateway Online – stream de dados ativo';
          }
        }, 20000);
      });

      btnMaint.addEventListener('click', function() {
        const site = sites[currentIndex];
        addEvent('info', 'Manutenção acionada', 'Ordem de manutenção emitida para ' + site.id + '.');
        showToast('Ordem de manutenção emitida para ' + site.id);
      });

      if (btnPdf) {
        btnPdf.addEventListener('click', function() {
          exportPdf();
          showToast('PDF gerado para o site atual');
        });
      }

      if (btnCsv) {
        btnCsv.addEventListener('click', function() {
          exportCsv();
          showToast('CSV exportado para o site atual');
        });
      }

      btnLogout.addEventListener('click', function() {
        addEvent('info', 'Logout simulado', 'Sessão do operador encerrada (apenas front-end).');
        showToast('Logout simulado. (Somente front-end)');
      });
    }

    function initRegisterForm() {
      const form = document.getElementById('formRegister');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('newId').value.trim().toUpperCase();
        const name = document.getElementById('newName').value.trim();
        const dist = parseFloat(document.getElementById('newDist').value);
        const factor = parseFloat(document.getElementById('newFactor').value);
        if (!id || !name || isNaN(dist) || isNaN(factor)) {
          showToast('Preencha todos os campos corretamente.');
          return;
        }
        sites.push({
          id: id,
          name: name,
          distKm: dist,
          envFactor: factor,
          region: 'ND',
          city: 'Novo Site',
          address: 'Endereço a definir',
          humidity: 70,
          wind: 10,
          sensorCu: 10,
          battery: 100,
          plateDamage: 0,
          zinc: 10,
          steel: 0,
          costSaved: 0,
          gwBattery: 100,
          gwSignal: -80
        });
        const sel = document.getElementById('siteSelect');
        const idx = sites.length - 1;
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = id + ' — ' + name;
        sel.appendChild(opt);
        sel.value = String(idx);
        sel.dispatchEvent(new Event('change'));
        form.reset();
        addEvent('info', 'Novo site cadastrado', 'Site ' + id + ' incluído na simulação.');
        showToast('Novo site cadastrado na simulação.');
      });
    }

    function initScenarioSelect() {
      const sel = document.getElementById('scenarioSelect');
      sel.addEventListener('change', function() {
        currentScenario = sel.value;
        const sc = SCENARIOS[currentScenario] || SCENARIOS.default;
        const site = sites[currentIndex];
        addEvent('info', 'Cenário atualizado', 'Novo cenário: ' + sc.label + '.');
        updateHeader(site);
        updateSensorCards(site);
        refreshRiskTable();
        showToast('Cenário alterado para ' + sc.label);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      initSiteSelect();
      initClock();
      initSidebarNav();
      initButtons();
      initRegisterForm();
      initScenarioSelect();
      initChart();

      const site = sites[currentIndex];
      updateHeader(site);
      updateSensorCards(site);
      refreshRiskTable();

      for (let i = 0; i < 10; i++) {
        stepSimulation();
      }

      addEvent('info', 'Monitoramento iniciado', 'Simulação local do parque TowerGuard carregada.');
    });
  
    /* ---------------- ARGUS (Copiloto) ---------------- */
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    const argus = {
      open: false,
      initDone: false,
    };

    function el(id){ return document.getElementById(id); }
    function nowTime(){
      const d = new Date();
      return d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }
    function addArgusMsg(who, text){
      const thread = el('argusThread');
      if(!thread) return;
      const msg = document.createElement('div');
      msg.className = 'tg-msg ' + (who === 'user' ? 'tg-msg--user' : 'tg-msg--argus');
      msg.innerHTML = `<div class="tg-msg__meta">${who==='user'?'Você':'ARGUS'} • ${nowTime()}</div>
                       <div class="tg-msg__text">${escapeHtml(String(text))}</div>`;
      thread.appendChild(msg);
      thread.scrollTop = thread.scrollHeight;
    }

    function getCurrentSite(){
      const sel = el('siteSelect');
      const siteId = sel ? sel.value : (sites[0]?.id || '');
      return sites.find(s => s.id === siteId) || sites[0];
    }

    function readDashboardSnapshot(){
      const site = getCurrentSite();
      // Values already computed by existing simulation update loop
      const iis = parseFloat((el('iisLabel')?.textContent || '0').replace('/100','')) || calcIIS(site);
      const iso = el('isoText')?.textContent || '';
      const city = site?.city || '';
      const region = site?.region || '';
      const cuMv = (el('cuValueLabel')?.textContent || '').trim(); // e.g. "24.07 mV"
      const cuDamage = el('cuDamageLabel')?.textContent || '--%';
      const zinc = el('zincLevelLabel')?.textContent || '--%';
      const steel = el('steelLevelLabel')?.textContent || '--%';
      const hum = el('humidityLabel')?.textContent || '--%';
      const wind = el('windLabel')?.textContent || '--';
      const vue = el('rulLabel')?.textContent || '--'; // VUE proteção
      const Risco = Math.round((typeof riskScore === 'function' ? riskScore(site) : Math.max(0, Math.min(100, 100 - iis))));

      const maint = el('maintText')?.textContent?.trim() || '';
      const maintTag = el('maintBadge')?.textContent?.trim() || '';

      return {
        site_id: site?.id,
        site_name: site?.name,
        city, region,
        iso, iis, Risco,
        cuMv, cuDamage, zinc, steel,
        hum, wind, vue,
        maint, maintTag
      };
    }

    function classifyState(Risco){
      if(Risco >= RISK_LEVELS.CRÍTICO) return 'CRÍTICO';
      if(Risco >= RISK_LEVELS.ATENÇÃO) return 'ATENÇÃO';
      return 'ESTÁVEL';
    }

    function argusGreeting(){
      const h = new Date().getHours();
      const greet = (h < 12) ? 'Bom dia' : (h < 18 ? 'Boa tarde' : 'Boa noite');
      return `${greet}. Quais dados do ativo você deseja agora?`;
    }

    function argusOffTopic(){
      return 'Não possuo informações fora do TowerGuard. Posso ajudar com risco, VUE, ambiente (umidade/vento) e planos de ação do ativo selecionado.';
    }

    function argusPlan(snapshot){
      // Keep simple: use existing maint block + a tiny recommendation
      const st = classifyState(snapshot.Risco);
      if(st === 'CRÍTICO'){
        return `Prioridade sugerida:\n• Acionar inspeção imediata no ativo ${snapshot.site_id}\n• Planejar intervenção na proteção (Zinco) conforme VUE\n• Registrar evidência (foto/vídeo) e abrir ordem de serviço\n\nContexto: Risco ${Math.round(snapshot.Risco)}/100 | VUE ${snapshot.vue}.`;
      }
      if(st === 'ATENÇÃO'){
        return `Atenção sugerida:\n• Acompanhar tendência nas próximas 24–72h\n• Programar janela de manutenção caso a tendência continue\n• Revisar exposição ambiental (umidade/vento) e histórico recente\n\nContexto: Risco ${Math.round(snapshot.Risco)}/100 | VUE ${snapshot.vue}.`;
      }
      return `Rotina sugerida:\n• Manter monitoramento contínuo\n• Revisar semanalmente eventos e tendência\n\nContexto: Risco ${Math.round(snapshot.Risco)}/100 | VUE ${snapshot.vue}.`;
    }

    function argusWhy(snapshot){
      const st = classifyState(snapshot.Risco);
      const lines = [];
      lines.push(`Ativo: ${snapshot.site_id} — ${snapshot.site_name}`);
      lines.push(`Estado: ${st} | Risco: ${snapshot.Risco}/100 | Índice de Integridade: ${snapshot.iis.toFixed(0)}/100`);
      lines.push(`Ambiente: Umidade ${snapshot.hum} | Vento ${snapshot.wind}`);
      lines.push(`Sensor (Cobre): ${snapshot.cuMv} | Nível acumulado: ${snapshot.cuDamage}`);
      lines.push(`Impacto estimado: Proteção (Zinco) ${snapshot.zinc} | Estrutura (Aço) ${snapshot.steel} | VUE ${snapshot.vue}`);
      lines.push(`Leitura: o sensor indica agressividade ambiental; o TowerGuard estima o impacto na proteção e no risco estrutural.`);
      return lines.join('\n');
    }

    function argusWhenToAct(snapshot){
      const st = classifyState(snapshot.Risco);
      if(st === 'CRÍTICO') return `Agora. O ativo está em CRÍTICO (risco ${snapshot.Risco}/100). Recomendo acionar inspeção e executar plano de ação imediatamente.`;
      if(st === 'ATENÇÃO') return `Em breve. O ativo está em ATENÇÃO (risco ${snapshot.Risco}/100). Sugiro acompanhar 24–72h e preparar janela de manutenção.`;
      return `Não é necessário agir agora. Estado ESTÁVEL (risco ${snapshot.Risco}/100). Manter monitoramento e revisar periodicamente.`;
    }

    function argusRegionDisambiguation(q){
      const up = q.toUpperCase();
      const regionHits = [];
      if(/\bSP\b/.test(up) || /\bS[ÃA]O\s*PAULO\b/.test(up)) regionHits.push('SP');
      if(/\bRJ\b/.test(up) || /\bRIO\b/.test(up)) regionHits.push('RJ');
      if(/\bNE\b/.test(up) || /\bNORDESTE\b/.test(up)) regionHits.push('NE');
      if(/\bSUL\b/.test(up)) regionHits.push('SUL');
      return regionHits;
    }

    function argusAnswer(q){
      const t = (q || '').trim();
      if(!t) return 'Me diga o que você quer analisar (ex.: “por que o risco subiu?”, “quando devo agir?”, “plano de ação”).';

      const low = t.toLowerCase();
      if(/^(oi|ol[aá]|bom dia|boa tarde|boa noite)\b/.test(low)) return argusGreeting();

      // Region disambiguation (SP/RJ/NE/SUL)
      const regions = argusRegionDisambiguation(t);
      if(regions.length){
        return `Você está se referindo a ativos na região ${regions.join(', ')}? Se sim, diga “listar ativos em ${regions[0]}” ou “selecionar ativo EV-XX-YY”.`;
      }

      // Off-topic examples
      if(low.includes('estado de') || low.includes('política') || low.includes('futebol') || low.includes('economia')){
        return argusOffTopic();
      }

      const snap = readDashboardSnapshot();

      if(low.includes('plano') || low.includes('proced') || low.includes('ação') || low.includes('acao')){
        return argusPlan(snap);
      }
      if(low.includes('por que') || low.includes('porque') || low.includes('motivo') || low.includes('o que mudou')){
        return argusWhy(snap);
      }
      if(low.includes('quando') || low.includes('devo agir') || low.includes('agir')){
        return argusWhenToAct(snap);
      }
      if(low.includes('resumo') || low.includes('24h') || low.includes('24 h')){
        return `Resumo (ativo selecionado): Risco ${snap.Risco}/100 | VUE ${snap.vue} | Umidade ${snap.hum} | Vento ${snap.wind} | Cu ${snap.cuMv} (${snap.cuDamage}).`;
      }
      if(low.includes('clima') || low.includes('umidade') || low.includes('vento') || low.includes('temperatura')){
        return `Ambiente no ativo ${snap.site_id}: Umidade ${snap.hum} | Vento ${snap.wind}. (Clima é usado para explicar variações de agressividade ambiental.)`;
      }

      return `Posso ajudar com: “por que o risco subiu?”, “quando devo agir?”, “resumo 24h”, “ambiente” e “plano de ação”.`;
    }

    function openArgus(){
      setArgusBadge(false);

      const modal = el('argusModal');
      if(!modal) return;
      modal.classList.remove('hidden');
      el('argusInput')?.focus();
      if(!argus.initDone){
        addArgusMsg('argus','ARGUS online. Estado do ativo carregado. O que deseja analisar agora?');
        argus.initDone = true;
      }
    }
    function closeArgus(){
      const modal = el('argusModal');
      if(!modal) return;
      modal.classList.add('hidden');
    }
    function sendArgus(){
      try{
        const input = el('argusInput');
      const q = input?.value || '';
      if(input) input.value = '';
      addArgusMsg('user', q);
      addArgusMsg('argus', argusAnswer(q));
      }catch(err){
        console.error("ARGUS error", err);
        addArgusMsg('argus', "Falha ao processar a mensagem. Abra o console para detalhes.");
      }
    }

    // Wire up handlers after DOM ready (already in your existing DOMContentLoaded)
    // We'll attach here safely:
    setTimeout(function(){
      el('btnArgus')?.addEventListener('click', openArgus);
      el('argusClose')?.addEventListener('click', closeArgus);
      el('argusBackdrop')?.addEventListener('click', closeArgus);
      el('argusSend')?.addEventListener('click', sendArgus);
      el('argusInput')?.addEventListener('keydown', function(e){
        if(e.key === 'Enter'){ e.preventDefault(); sendArgus(); }
        if(e.key === 'Escape'){ e.preventDefault(); closeArgus(); }
      });
    }, 0);



    /* ---------------- ARGUS (CARD FIXO) ---------------- */
    function addArgusMiniMsg(who, text){
      const thread = document.getElementById('argusMiniThread');
      if(!thread) return;
      const wrap = document.createElement('div');
      wrap.className = 'tg-msg ' + (who === 'user' ? 'tg-msg--user' : 'tg-msg--argus');
      wrap.style.maxWidth = '100%';
      wrap.innerHTML = `<div class="tg-msg__meta">${who==='user'?'Você':'ARGUS'} • ${nowTime()}</div>
                        <div class="tg-msg__text">${escapeHtml(String(text))}</div>`;
      thread.appendChild(wrap);
      thread.scrollTop = thread.scrollHeight;
    }

    function sendArgusMini(customQ){
      setArgusBadge(false);

      try{
        const input = document.getElementById('argusMiniInput');
        const q = (typeof customQ === 'string') ? customQ : (input?.value || '');
        if(input) input.value = '';
        if(!q.trim()) return;
        addArgusMiniMsg('user', q);
        const ans = argusAnswer(q);
        addArgusMiniMsg('argus', ans);

        // also keep modal thread in sync (if opened later)
        addArgusMsg('user', q);
        addArgusMsg('argus', ans);
      }catch(e){
        addArgusMiniMsg('argus', 'Falha ao processar sua pergunta. Recarregue a página (Ctrl+F5).');
        console.error(e);
      }
    }

    setTimeout(function(){
      // seed message once
      const mini = document.getElementById('argusMiniThread');
      if(mini && mini.childElementCount === 0){
        addArgusMiniMsg('argus','ARGUS online. Estado do ativo carregado. O que deseja analisar agora?');
      }

      document.getElementById('argusMiniSend')?.addEventListener('click', ()=>sendArgusMini());
      document.getElementById('argusMiniInput')?.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){ e.preventDefault(); sendArgusMini(); }
      });

      // quick chips
      document.querySelectorAll('#argusCard .tg-chip').forEach(btn=>{
        btn.addEventListener('click', ()=> sendArgusMini(btn.getAttribute('data-argusq') || ''));
      });

      // expand button opens modal
      document.getElementById('argusExpand')?.addEventListener('click', openArgus);
    }, 0);



    /* ---------------- ARGUS (UPGRADES: memória + alertas + demo) ---------------- */
    const ARGUS_MEM_KEY = "TG_ARGUS_MEMORY_V1";
    const ARGUS_BADGE_KEY = "TG_ARGUS_BADGE_V1";
    const ARGUS_POLL_MS = 15000; // 15s (demo-friendly)

    function loadMem(){
      try{
        return JSON.parse(localStorage.getItem(ARGUS_MEM_KEY) || "{}");
      }catch{ return {}; }
    }
    function saveMem(mem){
      try{ localStorage.setItem(ARGUS_MEM_KEY, JSON.stringify(mem)); }catch{}
    }
    function memPush(siteId, snap){
      const mem = loadMem();
      const arr = mem[siteId] || [];
      arr.push({ t: Date.now(), snap });
      // keep ~14 days with cap
      const cutoff = Date.now() - (14 * 24 * 3600 * 1000);
      const filtered = arr.filter(x => x.t >= cutoff).slice(-3000);
      mem[siteId] = filtered;
      saveMem(mem);
    }
    function memGet(siteId){
      const mem = loadMem();
      return mem[siteId] || [];
    }
    function statePT(label){
      if(label === "CRÍTICO") return "Crítico";
      if(label === "ATENÇÃO") return "Atenção";
      return "Estável";
    }
    function classifyPT(risk){
      if(risk >= (RISK_LEVELS?.critical ?? 80)) return "CRÍTICO";
      if(risk >= (RISK_LEVELS?.attention ?? 55)) return "ATENÇÃO";
      return "ESTÁVEL";
    }
    function fmtDateTime(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
      }catch{ return ""; }
    }
    function avg(arr){ return arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0; }

    function getWindow(siteId, hours){
      const all = memGet(siteId);
      const cutoff = Date.now() - (hours * 3600 * 1000);
      return all.filter(x => x.t >= cutoff);
    }
    function pickClosest(siteId, targetTs){
      const all = memGet(siteId);
      if(!all.length) return null;
      let best = all[0];
      let bestDist = Math.abs(all[0].t - targetTs);
      for(const x of all){
        const d = Math.abs(x.t - targetTs);
        if(d < bestDist){ best = x; bestDist = d; }
      }
      return best;
    }

    function summarizeHours(snapNow, hours){
      const siteId = snapNow.site_id;
      const win = getWindow(siteId, hours);
      if(win.length < 2){
        return `Ainda não há histórico suficiente para ${hours}h neste ativo. Mantenha a simulação rodando para consolidar tendências.`;
      }
      const risks = win.map(x => Number(x.snap.risk)||0);
      const hums = win.map(x => parseFloat(String(x.snap.hum).replace('%','')) || 0);
      const winds = win.map(x => parseFloat(String(x.snap.wind).replace(/[^\d.,]/g,'').replace(',','.')) || 0);

      const first = win[0].snap;
      const last = win[win.length-1].snap;

      const deltaRisk = (last.risk ?? 0) - (first.risk ?? 0);
      const stFirst = classifyPT(first.risk ?? 0);
      const stLast = classifyPT(last.risk ?? 0);

      const line1 = `Resumo ${hours}h (ativo ${siteId}): Estado ${statePT(stLast)} | Risco ${last.risk}/100 | VUE ${last.vue}.`;
      const line2 = `Variação de risco: ${deltaRisk>=0?'+':''}${deltaRisk} (de ${first.risk}/100 para ${last.risk}/100).`;
      const line3 = `Ambiente médio: Umidade ~${Math.round(avg(hums))}% | Vento ~${avg(winds).toFixed(1)} km/h.`;
      const line4 = (stFirst !== stLast) ? `Mudança de faixa: ${statePT(stFirst)} → ${statePT(stLast)}.` : `Faixa mantida: ${statePT(stLast)}.`;

      return [line1,line2,line3,line4].join("\n");
    }

    function whatChangedSinceYesterday(snapNow){
      const siteId = snapNow.site_id;
      const ref = pickClosest(siteId, Date.now() - (24*3600*1000));
      if(!ref){
        return "Ainda não há histórico de 24h suficiente para comparar. Assim que acumular dados, consigo dizer o que mudou desde ontem.";
      }
      const a = ref.snap;
      const b = snapNow;

      const dr = (b.risk ?? 0) - (a.risk ?? 0);
      const dVue = `VUE: ${a.vue} → ${b.vue}`;
      const dHum = `Umidade: ${a.hum} → ${b.hum}`;
      const dWind = `Vento: ${a.wind} → ${b.wind}`;
      const dState = `Estado: ${statePT(classifyPT(a.risk ?? 0))} → ${statePT(classifyPT(b.risk ?? 0))}`;

      return [
        `Comparativo 24h (ativo ${siteId}):`,
        `${dState}`,
        `Risco: ${a.risk}/100 → ${b.risk}/100 (${dr>=0?'+':''}${dr})`,
        dVue,
        dHum,
        dWind,
        `Referência: ${fmtDateTime(ref.t)}`
      ].join("\n");
    }

    // Alerts: notify when state band changes
    function setArgusBadge(on){
  const b = document.getElementById('argusInsightBadge');
  if(!b) return;
  if(on) b.classList.remove('hidden');
  else b.classList.add('hidden');
}

function loadBadge(){
      try{ return JSON.parse(localStorage.getItem(ARGUS_BADGE_KEY) || "{}"); }catch{ return {}; }
    }
    function saveBadge(b){ try{ localStorage.setItem(ARGUS_BADGE_KEY, JSON.stringify(b)); }catch{} }

    function argusNotify(text){
      setArgusBadge(true);

      // push into both threads (mini + modal) without duplicating user message
      addArgusMiniMsg('argus', text);
      addArgusMsg('argus', text);
    }

    function pollAndLearn(){
      const snap = readDashboardSnapshot();
      if(!snap?.site_id) return;

      // store memory
      memPush(snap.site_id, snap);

      // state change detection
      const badge = loadBadge();
      const prev = badge[snap.site_id]?.state;
      const curr = classifyPT(snap.risk ?? 0);
      if(prev && prev !== curr){
        const msg = `Alerta: mudança de faixa no ativo ${snap.site_id}: ${statePT(prev)} → ${statePT(curr)}. Risco atual ${snap.risk}/100.`;
        argusNotify(msg);
      }
      badge[snap.site_id] = { state: curr, risk: snap.risk, t: Date.now() };
      saveBadge(badge);
    }

    // Extend argusAnswer with new intents
    const _argusAnswerBase = argusAnswer;
    argusAnswer = function(q){
      const t = (q || "").trim();
      const low = t.toLowerCase();

      const snap = readDashboardSnapshot();

      if(low.includes("resumo 7") || low.includes("7 dias") || low.includes("7d")){
        return summarizeHours(snap, 24*7);
      }
      if(low.includes("resumo 24") || low.includes("24h") || low.includes("24 h")){
        return summarizeHours(snap, 24);
      }
      if(low.includes("ontem") || low.includes("desde ontem") || low.includes("o que mudou")){
        return whatChangedSinceYesterday(snap);
      }

      if(low.includes("demo") || low.includes("apresentação") || low.includes("apresentacao")){
        return [
          "Modo demo (rápido):",
          "1) Pergunte: “por que o risco subiu?”",
          "2) Depois: “quando devo agir?”",
          "3) Depois: “plano de ação”",
          "4) Finalize: “resumo 24h” ou “resumo 7 dias”.",
          "Dica: clique em outro ativo para mostrar comparação por região."
        ].join("\n");
      }

      return _argusAnswerBase(q);
    };

    // Start polling after load
    setTimeout(function(){
      pollAndLearn(); // immediate
      setInterval(pollAndLearn, ARGUS_POLL_MS);
    }, 1200);



    /* -------- DEMO+ (cenários + eventos) -------- */
    const DEMO_SCENARIOS = {
      normal:    { hum: 60, wind: 8,  riskDelta: 0,  label: "Normal" },
      agressivo: { hum: 80, wind: 14, riskDelta: 8,  label: "Ambiente agressivo" },
      calor:     { hum: 65, wind: 10, riskDelta: 6,  label: "Onda de calor" },
      maresia:   { hum: 85, wind: 18, riskDelta: 12, label: "Maresia severa" },
      tempestade:{ hum: 90, wind: 22, riskDelta: 15, label: "Pós-tempestade" },
    };

    function setDemoOverride(o){
      window.__DEMO_OVERRIDE__ = o || null;
    }

    function getDemoOverride(){
      return window.__DEMO_OVERRIDE__ || null;
    }

    function applyScenario(name){
      const s = DEMO_SCENARIOS[name] || DEMO_SCENARIOS.normal;
      setDemoOverride({ ...s, name });
      const msg = `Cenário aplicado: ${s.label}. Ajustando ambiente e risco (demo).`;
      if(typeof argusNotify === 'function') argusNotify(msg);
      else if(typeof addArgusMiniMsg === 'function') addArgusMiniMsg('argus', msg);
      // log to timeline if available
      if(typeof pushEvent === 'function') pushEvent("DEMO", msg, "Evento");
    }

    function demoEvent(type){
      const o = getDemoOverride() || { ...DEMO_SCENARIOS.normal, name: "normal" };
      if(type === "humidity"){
        o.hum = Math.min(98, (o.hum || 60) + 12);
        o.riskDelta = Math.min(25, (o.riskDelta || 0) + 4);
        setDemoOverride(o);
        argusNotify(`Evento (demo): Umidade elevada detectada. Ambiente mais agressivo.`);
        if(typeof pushEvent === 'function') pushEvent("AMBIENTE", "Umidade elevada detectada (demo). Possível aceleração de corrosão.", "Evento");
      }
      if(type === "drywet"){
        o.riskDelta = Math.min(30, (o.riskDelta || 0) + 6);
        setDemoOverride(o);
        argusNotify(`Evento (demo): Ciclo seco–úmido intensificado. Tendência de risco ajustada.`);
        if(typeof pushEvent === 'function') pushEvent("AMBIENTE", "Ciclo seco–úmido intensificado (demo).", "Evento");
      }
      if(type === "critical"){
        o.riskDelta = 35;
        o.hum = 92;
        o.wind = 24;
        setDemoOverride(o);
        argusNotify(`Evento (demo): Condição crítica simulada. Verifique plano de ação do ativo.`);
        if(typeof pushEvent === 'function') pushEvent("SISTEMA", "Alerta crítico simulado (demo).", "Alerta");
      }
    }

    // Wire UI
    setTimeout(()=>{
      const sel = document.getElementById('demoScenario');
      if(sel){
        sel.addEventListener('change', e => applyScenario(e.target.value));
        applyScenario(sel.value); // start deterministic
      }
      document.getElementById('demoEventHumidity')?.addEventListener('click', ()=>demoEvent("humidity"));
      document.getElementById('demoEventDryWet')?.addEventListener('click', ()=>demoEvent("drywet"));
      document.getElementById('demoEventCritical')?.addEventListener('click', ()=>demoEvent("critical"));
    }, 800);

</script>

<script>
/* ===================== TowerGuard DEMO ENTERPRISE ADDONS (SAFE) ===================== */

/* --- Timeline Narrativa: registra eventos em linguagem humana --- */
function narrateEvent(type, payload){
  const map = {
    'scenario': (p)=> `Cenário aplicado: ${p}. O ambiente entrou em um novo regime operacional.`,
    'humidity_up': ()=> `Aumento de umidade detectado. Eletrólito persistente eleva a agressividade ambiental.`,
    'dry_wet': ()=> `Ciclo seco–úmido intensificado. Este padrão acelera a degradação da proteção.`,
    'risk_up': (p)=> `Risco ajustado para ${p}/100. Janela de manutenção começa a se fechar.`,
    'state_change': (p)=> `Mudança de faixa: ${p.from} → ${p.to}. Atenção operacional requerida.`,
  };
  return (map[type] ? map[type](payload) : 'Evento operacional registrado.');
}

function pushNarrative(type, payload){
  const text = narrateEvent(type, payload);
  if(typeof addTimelineEvent === 'function'){
    addTimelineEvent('ARGUS', text);
  }
  if(typeof addArgusMiniMsg === 'function'){
    addArgusMiniMsg('argus', text);
  }
}

/* --- Helpers --- */
function safeGetSites(){
  return (window.sites || window.SITES || []);
}
function classifyPT_LOCAL(risk){
  if(typeof classifyPT === "function") return classifyPT(risk);
  if(risk >= 80) return "CRÍTICO";
  if(risk >= 55) return "ATENÇÃO";
  return "ESTÁVEL";
}

/* --- P1: Prioridades do dia --- */
function argusPrioridades(){
  const sitesArr = safeGetSites();
  if(!sitesArr.length) return "Sem ativos suficientes para priorização.";
  const ranked = sitesArr.map(s=>{
    const r = Math.round(typeof riskScore==='function'?riskScore(s):0);
    return {id:s.id||s.name||"ATIVO", risk:r};
  }).sort((a,b)=>b.risk-a.risk).slice(0,3);
  return "Prioridades do dia:\n" + ranked.map((x,i)=>`${i+1}) ${x.id} — Risco ${x.risk}/100`).join("\n");
}

/* --- P2: Decompor risco (explicabilidade heurística) --- */
function argusDecompor(){
  if(typeof readDashboardSnapshot !== "function") return "Snapshot indisponível.";
  const snap = readDashboardSnapshot();
  const env = Math.round((snap.risk||0)*0.5);
  const trend = Math.round((snap.risk||0)*0.3);
  const lim = Math.round((snap.risk||0)*0.2);
  return `Decomposição do risco (${snap.risk}/100):\n- Ambiente: ${env}\n- Tendência: ${trend}\n- Proximidade de limiar: ${lim}`;
}

/* --- P3: Caderno de bordo (memória) --- */
function argusCaderno(){
  const site = (typeof readDashboardSnapshot==="function" ? readDashboardSnapshot().site_id : "ATIVO");
  let mem = {};
  try{ mem = JSON.parse(localStorage.getItem('TG_ARGUS_MEMORY_V1')||'{}'); }catch{}
  const arr = mem[site]||[];
  if(!arr.length) return "Sem histórico suficiente para caderno de bordo.";
  const last = arr.slice(-5);
  return "Caderno de bordo (últimos registros):\n" + last.map(x=>`• ${new Date(x.t).toLocaleString('pt-BR')} — Risco ${x.snap.risk}/100`).join("\n");
}

/* --- P4: Modo apresentação (roteiro) --- */
function argusApresentacao(){
  const seq = ["resumo 24h","por que o risco subiu?","quando devo agir?","plano de ação"];
  return "Modo Apresentação (roteiro):\n" + seq.map((q,i)=>`${i+1}) ${q}`).join("\n");
}

/* --- Playbook por severidade --- */
function argusPlaybook(){
  const snap = (typeof readDashboardSnapshot==="function" ? readDashboardSnapshot() : {risk:0, site_id:"ATIVO"});
  const risk = snap.risk||0;
  const sev = classifyPT_LOCAL(risk);

  if(sev === "CRÍTICO"){
    return `Playbook — CRÍTICO
Ação imediata:
- Acionar inspeção em campo
- Registrar evidências (foto/vídeo)
- Avaliar condição da proteção

Em 72h:
- Planejar intervenção
- Atualizar cronograma e prioridade

Evidências:
- Fotos e registro do painel
- Eventos da timeline

Resultado esperado:
- Conter avanço do risco`;
  }
  if(sev === "ATENÇÃO"){
    return `Playbook — ATENÇÃO
Ação imediata:
- Monitorar tendência e ambiente
- Verificar eventos recentes

Em 72h:
- Planejar manutenção preventiva
- Confirmar janela operacional

Evidências:
- Histórico 24h/7d
- Eventos da timeline

Resultado esperado:
- Evitar escalada para Crítico`;
  }
  return `Playbook — ESTÁVEL
Ação imediata:
- Manter monitoramento contínuo

Rotina:
- Checklist semanal
- Revisão de tendência

Resultado esperado:
- Operação dentro do esperado`;
}

/* --- Exportação DEMO CSV --- */
function argusExportCSV(){
  const snap = (typeof readDashboardSnapshot==="function" ? readDashboardSnapshot() : {});
  const rows = [
    ["Ativo", snap.site_id || ""],
    ["Risco", snap.risk ?? ""],
    ["VUE", snap.vue ?? ""],
    ["Estado", classifyPT_LOCAL(snap.risk||0)],
    ["Ambiente", `Umidade ${snap.hum||""} | Vento ${snap.wind||""}`],
    ["Observação", "DEMONSTRAÇÃO"]
  ];
  const csv = "Campo,Valor\n" + rows.map(r=>r.map(x=>String(x).replaceAll(",",";")).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `TowerGuard_DEMO_${snap.site_id||"ATIVO"}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* --- Hook: cenário demo gera evento narrativo --- */
setTimeout(()=>{
  const sel = document.getElementById('demoScenario');
  if(sel){
    sel.addEventListener('change', e=>{
      const label = e.target.options[e.target.selectedIndex].text;
      pushNarrative('scenario', label);
    });
  }
}, 800);

/* --- Extensão segura do argusAnswer sem sobrescrever cadeia várias vezes --- */
(function(){
  if(typeof argusAnswer !== "function") return;
  if(window.__TG_ARGUS_ENTERPRISE__) return;
  window.__TG_ARGUS_ENTERPRISE__ = true;

  const baseAnswer = argusAnswer;
  window.argusAnswer = function(q){
    const low = String(q||"").toLowerCase();

    if(low.includes("prioridade")) return argusPrioridades();
    if(low.includes("decompor")) return argusDecompor();
    if(low.includes("caderno")) return argusCaderno();
    if(low.includes("apresenta")) return argusApresentacao();
    if(low.includes("playbook") || low.includes("checklist")) return argusPlaybook();
    if(low.includes("exportar") || low.includes("relat")){
      argusExportCSV();
      return "Relatório DEMO exportado em CSV.";
    }
    return baseAnswer(q);
  };
})();
</script>


<script>
/* ===================== COMPARAÇÃO + PDF DEMO ===================== */

/* --- Comparar dois ativos (gestor) --- */
function argusComparar(ativoA, ativoB){
  const sites = (window.sites || window.SITES || []);
  const a = sites.find(s=> (s.id||s.name)===ativoA);
  const b = sites.find(s=> (s.id||s.name)===ativoB);
  if(!a || !b) return "Não encontrei os dois ativos para comparação.";

  const ra = Math.round(typeof riskScore==='function'?riskScore(a):0);
  const rb = Math.round(typeof riskScore==='function'?riskScore(b):0);

  return `Comparação de ativos:
${ativoA}: Risco ${ra}/100
${ativoB}: Risco ${rb}/100

Prioridade: ${ra>rb?ativoA:ativoB}`;
}

/* --- Exportar Parecer PDF DEMO (mock) --- */
function argusExportPDF(){
  const snap = readDashboardSnapshot();
  const content = `
TowerGuard – Parecer Técnico (DEMONSTRAÇÃO)

Ativo: ${snap.site_id}
Estado: ${classifyPT(snap.risk)}
Risco: ${snap.risk}/100
VUE: ${snap.vue}

Ambiente:
- Umidade: ${snap.hum}
- Vento: ${snap.wind}

Conclusão:
Este parecer foi gerado pelo ARGUS em modo demonstração.
`;

  const blob = new Blob([content], {type:"application/pdf"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Parecer_DEMO_${snap.site_id}.pdf`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* --- Extender intents --- */
(function(){
  if(typeof argusAnswer!=="function") return;
  const base = argusAnswer;
  argusAnswer = function(q){
    const low = (q||"").toLowerCase();
    if(low.startsWith("comparar")){
      const parts = q.split(" ");
      if(parts.length>=3) return argusComparar(parts[1], parts[2]);
      return "Use: comparar ATIVO_A ATIVO_B";
    }
    if(low.includes("pdf") || low.includes("parecer")){
      argusExportPDF();
      return "Parecer técnico DEMO gerado em PDF.";
    }
    return base(q);
  };
})();
</script>


<script>
/* ===================== DEMO: Baseline 0 + ENV_STATE por ativo (SAFE PATCH) ===================== */
(function(){
  // Global flags
  window.__TG_DEMO_MODE__ = true;
  window.__DEMO_BASELINE__ = 0;

  // Per-asset environment state (source of truth)
  const envBySite = window.__TG_ENV_BY_SITE__ = window.__TG_ENV_BY_SITE__ || {};
  const defaultEnv = { humidity: 0, wind: 0, rainRisk: 0, temperature: 25, scenario: "Inicial" };

  function getSiteId(){
    const snap = (typeof readDashboardSnapshot === "function") ? readDashboardSnapshot() : null;
    if(snap && snap.site_id) return snap.site_id;
    const sel = document.getElementById('siteSelect');
    return sel ? sel.value : "";
  }

  function getEnv(siteId){
    if(!siteId) return { ...defaultEnv };
    if(!envBySite[siteId]) envBySite[siteId] = { ...defaultEnv };
    return envBySite[siteId];
  }

  function setEnv(siteId, patchObj){
    if(!siteId) return;
    const cur = getEnv(siteId);
    envBySite[siteId] = { ...cur, ...patchObj };
  }

  // UI sync (best-effort)
  function setText(id, val){
    const el = document.getElementById(id);
    if(el) el.textContent = val;
  }

  function refreshEnvUI(){
    const siteId = getSiteId();
    if(!siteId) return;
    const env = getEnv(siteId);

    // These ids exist in our demo builds (humidityLabel/windLabel). Others are best-effort.
    setText('humidityLabel', `${Math.round(env.humidity)}%`);
    setText('windLabel', `${Number(env.wind).toFixed(1)} km/h`);

    // Optional labels (only if present in your layout)
    setText('rainLabel', `${Math.round(env.rainRisk)}%`);
    setText('tempLabel', `${Math.round(env.temperature)}°C`);

    // Let ARGUS know (optional message)
    // no spam: only on scenario changes
  }

  // Override/augment scenario application to write ENV_STATE for the selected asset
  const originalApplyScenario = window.applyScenario;
  window.applyScenario = function(name){
    const siteId = getSiteId();
    // If DEMO_SCENARIOS exists, use it; otherwise keep minimal
    const s = (window.DEMO_SCENARIOS && window.DEMO_SCENARIOS[name]) ? window.DEMO_SCENARIOS[name] : null;

    const envPatch = s ? {
      humidity: s.hum ?? 0,
      wind: s.wind ?? 0,
      // if scenario defines rain/temp, use; else derive simple defaults
      rainRisk: (s.rain ?? (name === 'tempestade' ? 75 : name === 'maresia' ? 45 : 20)),
      temperature: (s.temp ?? (name === 'calor' ? 38 : 28)),
      scenario: (name || "Demo")
    } : { scenario: (name || "Demo") };

    setEnv(siteId, envPatch);
    refreshEnvUI();

    if(typeof addArgusMiniMsg === 'function'){
      const env = getEnv(siteId);
      addArgusMiniMsg('argus', `Cenário aplicado no ativo ${siteId}: ${env.scenario}. Umidade ${Math.round(env.humidity)}%, vento ${Number(env.wind).toFixed(1)} km/h, risco de chuva ${Math.round(env.rainRisk)}%.`);
    }

    // Preserve any original behavior
    if(typeof originalApplyScenario === 'function'){
      try{ originalApplyScenario(name); }catch(e){ /* ignore */ }
    }
  };

  // Hard reset baseline at load: set all assets to 0 env => risk 0
  function initBaselineZero(){
    const sites = (window.sites || window.SITES || []);
    for(const s of sites){
      const id = s.id || s.name;
      if(id && !envBySite[id]) envBySite[id] = { ...defaultEnv };
    }
    refreshEnvUI();
  }

  // DEMO risk model: replaces riskScore() in demo mode so it starts at 0
  const originalRiskScore = window.riskScore;
  window.riskScore = function(site){
    if(!window.__TG_DEMO_MODE__) {
      return (typeof originalRiskScore === 'function') ? originalRiskScore(site) : 0;
    }
    const siteId = site ? (site.id || site.name) : getSiteId();
    const env = getEnv(siteId);

    // Simple, controllable model (0..100) — starts at 0 when env is 0
    const base = Number(window.__DEMO_BASELINE__ || 0);
    const hum = Math.max(0, Math.min(100, Number(env.humidity || 0)));
    const wind = Math.max(0, Math.min(60, Number(env.wind || 0)));
    const rain = Math.max(0, Math.min(100, Number(env.rainRisk || 0)));
    const temp = Math.max(0, Math.min(60, Number(env.temperature || 25)));

    // Weights tuned for demo clarity (not claiming physical precision)
    const score = base
      + hum * 0.28
      + wind * 0.55
      + rain * 0.22
      + Math.max(0, temp - 25) * 0.6;

    return Math.max(0, Math.min(100, Math.round(score)));
  };

  // Make ARGUS climate answers use ENV_STATE as source of truth
  if(typeof readDashboardSnapshot === "function"){
    const _readSnap = readDashboardSnapshot;
    window.readDashboardSnapshot = function(){
      const snap = _readSnap();
      try{
        const env = getEnv(snap.site_id);
        // override visible fields so ARGUS and UI are coherent
        snap.hum = `${Math.round(env.humidity)}%`;
        snap.wind = `${Number(env.wind).toFixed(1)} km/h`;
        snap.rainRisk = `${Math.round(env.rainRisk)}%`;
        snap.temperature = `${Math.round(env.temperature)}°C`;
        snap.scenario = env.scenario;
      }catch(e){}
      return snap;
    };
  }

  // Ensure UI updates when switching assets
  setTimeout(()=>{
    const sel = document.getElementById('siteSelect');
    if(sel){
      sel.addEventListener('change', ()=> setTimeout(refreshEnvUI, 50));
    }
    initBaselineZero();
    // periodic refresh so UI never drifts
    setInterval(refreshEnvUI, 2000);
  }, 700);

})();
</script>

</body>
</html>
