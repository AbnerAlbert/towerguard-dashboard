<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>TowerGuard Pro – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','-apple-system','Segoe UI','Roboto','Arial','sans-serif'],
          },
        },
      },
    };
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />

  <style>
    html, body { height: 100%; }
    body {
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: #e5e7eb;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
    }
    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.06), transparent 55%), rgba(15,23,42,0.96);
      border-radius: 1rem;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 20px 40px rgba(15,23,42,0.8);
    }
    .chip {
      border-radius: 999px;
      padding: 0.15rem 0.7rem;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .badge-dot {
      width: 0.6rem;
      height: 0.6rem;
      border-radius: 999px;
    }
    .pulse {
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(52,211,153,0.4); }
      70%  { box-shadow: 0 0 0 10px rgba(52,211,153,0); }
      100% { box-shadow: 0 0 0 0 rgba(52,211,153,0); }
    }
    .toast {
      position: fixed;
      right: 1.5rem;
      bottom: 1.5rem;
      background: rgba(16,185,129,0.12);
      color: #bbf7d0;
      border: 1px solid rgba(16,185,129,0.4);
      padding: 0.8rem 1.3rem;
      border-radius: 999px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      opacity: 0;
      transform: translateY(10px);
      transition: all .25s ease-out;
      pointer-events: none;
      z-index: 50;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .sidebar-item-active {
      background: linear-gradient(to right, rgba(37,99,235,0.4), transparent);
      border-color: rgba(96,165,250,0.9);
      color: #e5e7eb;
    }
    .sidebar-item {
      transition: all .2s ease-out;
    }
    .sidebar-item:hover {
      background-color: rgba(15,23,42,0.85);
    }
    .page-section {
      display: none;
    }
    .page-section.active {
      display: block;
    }
  </style>
</head>
<body class="dark">
  <div class="h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-950/95 border-r border-slate-800 flex flex-col">
      <!-- Topo com logo -->
      <div class="px-4 py-4 flex items-center gap-3 border-b border-slate-800">
        <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-blue-500 to-sky-400 flex items-center justify-center shadow-lg shadow-blue-500/40">
          <i class="fa-solid fa-tower-cell text-xl text-white"></i>
        </div>
        <div>
          <p class="text-[0.60rem] uppercase tracking-[0.30em] text-slate-500">TowerGuard</p>
          <p class="text-sm font-semibold tracking-tight text-slate-100">
            Command Center <span class="text-blue-400">Pro</span>
          </p>
          <p class="text-[0.65rem] text-slate-500">Enterprise Edition</p>
        </div>
      </div>

      <!-- Menu -->
      <nav class="flex-1 px-3 py-4 space-y-1 text-sm">
        <button data-page-target="dashboard" class="sidebar-item sidebar-item-active w-full flex items-center gap-2 px-3 py-2 rounded-lg border border-transparent text-slate-200 text-left">
          <i class="fa-solid fa-chart-line text-sky-400 w-5"></i>
          Dashboard
        </button>
        <button data-page-target="reports" class="sidebar-item w-full flex items-center gap-2 px-3 py-2 rounded-lg border border-transparent text-slate-300 text-left">
          <i class="fa-solid fa-file-lines text-emerald-400 w-5"></i>
          Relatórios
        </button>
        <button data-page-target="register" class="sidebar-item w-full flex items-center gap-2 px-3 py-2 rounded-lg border border-transparent text-slate-300 text-left">
          <i class="fa-solid fa-plus-circle text-blue-300 w-5"></i>
          Cadastro de Sites
        </button>
        <button data-page-target="map" class="sidebar-item w-full flex items-center gap-2 px-3 py-2 rounded-lg border border-transparent text-slate-300 text-left">
          <i class="fa-solid fa-location-dot text-amber-300 w-5"></i>
          Mapa
        </button>
      </nav>

      <!-- Usuário + Sair -->
      <div class="px-3 py-3 border-t border-slate-800 flex items-center justify-between text-xs text-slate-400">
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-full bg-slate-800 flex items-center justify-center text-[0.7rem] text-slate-200">
            AA
          </div>
          <div>
            <p class="font-semibold text-slate-200 text-[0.78rem]">Abner Albert</p>
            <p class="text-[0.65rem] text-slate-500">Operador NOC</p>
          </div>
        </div>
        <button id="btnLogout" class="chip bg-red-900/40 border border-red-500/50 text-red-300 flex items-center gap-1">
          <i class="fa-solid fa-right-from-bracket"></i>
          Sair
        </button>
      </div>
    </aside>

    <!-- MAIN AREA -->
    <div class="flex-1 flex flex-col">
      <!-- HEADER -->
      <header class="h-16 px-6 border-b border-slate-800 flex items-center justify-between bg-slate-950/80 backdrop-blur">
        <div class="flex items-center gap-4">
          <div>
            <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Site Monitorado</p>
            <div class="flex items-center gap-2">
              <select id="siteSelect" class="bg-slate-900/90 border border-slate-700 text-xs rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-blue-500"></select>
              <span id="siteIsoBadge" class="chip bg-slate-900/80 border border-slate-700 text-slate-300 flex items-center gap-1">
                <span class="badge-dot bg-blue-500"></span>
                <span id="isoText">ISO 9223</span>
              </span>
            </div>
          </div>

          <div id="connBadge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-900/30 border border-emerald-500/50 text-xs text-emerald-300">
            <span class="badge-dot bg-emerald-400 pulse"></span>
            <span id="connText">Gateway Online</span>
          </div>
        </div>

        <div class="flex items-center gap-4 text-xs text-slate-400">
          <div class="hidden md:flex items-center gap-2">
            <i class="fa-solid fa-clock text-slate-500"></i>
            <span id="clockLabel">--:--:--</span>
          </div>

          <div class="hidden md:flex items-center gap-2">
            <span class="text-[0.70rem] text-slate-500">Cenário:</span>
            <select id="scenarioSelect" class="bg-slate-900/90 border border-slate-700 text-xs rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="default">Padrão</option>
              <option value="coastal">Costeiro Severo</option>
              <option value="urban">Urbano Costeiro</option>
              <option value="inland">Interior Seco</option>
            </select>
          </div>

          <button id="btnSim" class="px-3 py-1.5 rounded-full bg-blue-600 hover:bg-blue-500 text-xs font-semibold shadow shadow-blue-500/40">
            Iniciar Simulação
          </button>
          <button id="btnPresent" class="px-3 py-1.5 rounded-full bg-amber-500/90 hover:bg-amber-400 text-xs font-semibold text-slate-900">
            Modo Executivo
          </button>
        </div>
      </header>

      <!-- CONTENT -->
      <main class="flex-1 overflow-auto bg-slate-950/80 p-5 space-y-4">

        <!-- PAGE: DASHBOARD -->
        <section id="page-dashboard" class="page-section active space-y-4">
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
            <!-- Col 1 -->
            <div class="xl:col-span-2 space-y-4">
              <div class="card p-4">
                <div class="flex flex-wrap justify-between gap-4 items-center">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Resumo do Site</p>
                    <h2 id="siteTitle" class="text-lg font-semibold text-slate-100">--</h2>
                    <p id="siteSubtitle" class="text-xs text-slate-400">--</p>
                  </div>
                  <div class="flex gap-6 xl:gap-10">
                    <div class="text-right">
                      <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Categoria ISO 9223</p>
                      <p id="isoLabel" class="text-2xl font-bold text-blue-400">--</p>
                      <p class="text-[0.70rem] text-slate-500">Ambiente de corrosividade</p>
                    </div>
                    <div class="text-right">
                      <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Vida Útil Prot. Zinco</p>
                      <p id="rulLabel" class="text-2xl font-bold text-emerald-400">--</p>
                      <p class="text-[0.70rem] text-slate-500">Estimativa até limite crítico</p>
                    </div>
                    <div class="text-right">
                      <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Índice de Integridade</p>
                      <p id="iisLabel" class="text-2xl font-bold text-violet-400">--/100</p>
                      <p class="text-[0.70rem] text-slate-500">Composto (Zinco, Aço, ambiente)</p>
                    </div>
                  </div>
                </div>

                <!-- Widgets de região / clima -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4">
                  <div class="bg-slate-900/80 rounded-xl p-3 text-xs">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Região</p>
                    <p id="regionLabel" class="text-sm font-semibold text-slate-100">--</p>
                  </div>
                  <div class="bg-slate-900/80 rounded-xl p-3 text-xs">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Umidade do ar</p>
                    <p id="humidityLabel" class="text-sm font-semibold text-sky-300">--%</p>
                  </div>
                  <div class="bg-slate-900/80 rounded-xl p-3 text-xs">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Vento</p>
                    <p id="windLabel" class="text-sm font-semibold text-emerald-300">-- km/h</p>
                  </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4">
                  <!-- Sensor Cu -->
                  <div class="bg-slate-900/90 rounded-xl p-3 border border-slate-700/70">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Sensor Sacrificial (Cobre)</p>
                    <p id="cuValueLabel" class="text-xl font-bold text-sky-400 mb-1">-- mV</p>
                    <div class="grid grid-cols-2 gap-2 text-[0.70rem] text-slate-300">
                      <div>
                        <p class="text-slate-400">Bateria</p>
                        <p><span id="cuBatteryLabel" class="text-emerald-400">--%</span></p>
                        <div class="w-full bg-slate-800 rounded-full h-1.5 mt-1 overflow-hidden">
                          <div id="cuBatteryBar" class="h-1.5 rounded-full bg-gradient-to-r from-emerald-400 to-lime-300" style="width:0%"></div>
                        </div>
                        <p id="cuBatteryLife" class="text-[0.65rem] text-slate-500 mt-1">-- dias restantes</p>
                      </div>
                      <div>
                        <p class="text-slate-400">Dano da Placa</p>
                        <p><span id="cuDamageLabel" class="text-amber-300">--%</span></p>
                        <div class="w-full bg-slate-800 rounded-full h-1.5 mt-1 overflow-hidden">
                          <div id="cuDamageBar" class="h-1.5 rounded-full bg-gradient-to-r from-amber-400 to-red-500" style="width:0%"></div>
                        </div>
                        <p id="cuDamageLife" class="text-[0.65rem] text-slate-500 mt-1">Vida restante: --%</p>
                      </div>
                    </div>
                  </div>

                  <!-- Zinco -->
                  <div class="bg-slate-900/90 rounded-xl p-3 border border-slate-700/70">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Proteção (Zinco)</p>
                    <p class="text-xl font-bold">
                      <span id="zincLevelLabel" class="text-emerald-400">--%</span>
                    </p>
                    <div class="w-full bg-slate-800 rounded-full h-1.5 mt-1 overflow-hidden">
                      <div id="zincBar" class="h-1.5 rounded-full bg-gradient-to-r from-emerald-400 to-lime-400" style="width:0%"></div>
                    </div>
                    <p class="text-[0.70rem] text-slate-500 mt-1">
                      Limite crítico: <span class="text-emerald-300">100%</span>
                    </p>
                  </div>

                  <!-- Aço -->
                  <div class="bg-slate-900/90 rounded-xl p-3 border border-slate-700/70">
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Dano em Estrutura (Aço)</p>
                    <p class="text-xl font-bold">
                      <span id="steelLevelLabel" class="text-amber-300">--%</span>
                    </p>
                    <div class="w-full bg-slate-800 rounded-full h-1.5 mt-1 overflow-hidden">
                      <div id="steelBar" class="h-1.5 rounded-full bg-gradient-to-r from-amber-400 to-red-500" style="width:0%"></div>
                    </div>
                    <p class="text-[0.70rem] text-slate-500 mt-1">
                      Limite de alerta: <span class="text-orange-300">30%</span>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Gráfico -->
              <div class="card p-4">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Histórico</p>
                    <h3 class="text-sm font-semibold text-slate-100">Tendência de Corrosão (simulação)</h3>
                  </div>
                  <div class="flex gap-2 text-[0.65rem] text-slate-400">
                    <span class="inline-flex items-center gap-1">
                      <span class="w-3 h-0.5 bg-sky-400 inline-block"></span>Cu
                    </span>
                    <span class="inline-flex items-center gap-1">
                      <span class="w-3 h-0.5 bg-emerald-400 inline-block"></span>Zinco
                    </span>
                    <span class="inline-flex items-center gap-1">
                      <span class="w-3 h-0.5 bg-orange-400 inline-block"></span>Aço
                    </span>
                  </div>
                </div>
                <div class="h-64">
                  <canvas id="mainChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Col 2 -->
            <div class="space-y-4">
              <!-- Ranking -->
              <div class="card p-4 h-[230px] flex flex-col">
                <div class="flex justify-between items-center mb-2">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500">Parque Monitorado</p>
                    <h3 class="text-sm font-semibold text-slate-100">Ranking de Risco</h3>
                  </div>
                  <span class="chip bg-slate-900/80 border border-slate-600/60 text-slate-300 flex items-center gap-1">
                    <i class="fa-solid fa-fire-flame-curved text-orange-400"></i>Prioridade
                  </span>
                </div>
                <div class="flex-1 overflow-auto">
                  <table class="w-full text-xs text-slate-300">
                    <thead class="text-[0.65rem] uppercase tracking-[0.12em] text-slate-500 border-b border-slate-800">
                      <tr>
                        <th class="py-1 text-left">Site</th>
                        <th class="py-1 text-right">Zinco</th>
                        <th class="py-1 text-right">Aço</th>
                        <th class="py-1 text-right">Risco</th>
                      </tr>
                    </thead>
                    <tbody id="riskTableBody"></tbody>
                  </table>
                </div>
              </div>

              <!-- Timeline de eventos -->
              <div class="card p-4 h-[180px] flex flex-col">
                <div class="flex justify-between items-center mb-2">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500">Eventos Recentes</p>
                    <h3 class="text-sm font-semibold text-slate-100">Timeline Operacional</h3>
                  </div>
                  <span class="chip bg-slate-900/80 border border-slate-700 text-slate-300 flex items-center gap-1">
                    <i class="fa-solid fa-stream text-sky-400"></i>Log
                  </span>
                </div>
                <div id="timelineList" class="flex-1 overflow-auto text-xs text-slate-300"></div>
              </div>

              <!-- Manutenção -->
              <div class="card p-4 space-y-3">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.2em] text-slate-500">Ação Recomendada</p>
                    <h3 class="text-sm font-semibold text-slate-100">Janela de Manutenção Preditiva</h3>
                  </div>
                  <div id="maintBadge" class="chip bg-emerald-900/40 border border-emerald-500/40 text-emerald-300 flex items-center gap-1">
                    <span class="badge-dot bg-emerald-400"></span>Saudável
                  </div>
                </div>
                <p id="maintText" class="text-xs text-slate-300">
                  Nenhum limite crítico atingido para o site atual. Sistema em monitoramento contínuo.
                </p>

                <div class="mt-1 text-[0.70rem] text-slate-300 space-y-1">
                  <p class="text-slate-400 font-semibold">Tempo Estimado até Falha (simulação)</p>
                  <p>Sensor Cu: <span id="tefCu" class="text-sky-300">--</span></p>
                  <p>Proteção Zinco: <span id="tefZinc" class="text-emerald-300">--</span></p>
                  <p>Estrutura Aço: <span id="tefSteel" class="text-orange-300">--</span></p>
                </div>

                <button id="btnMaint" class="w-full mt-1 flex items-center justify-center gap-2 text-xs font-semibold px-3 py-2 rounded-xl bg-slate-800 border border-slate-600/70 text-slate-100 hover:bg-red-600 hover:border-red-400 hover:text-white transition disabled:opacity-40 disabled:cursor-not-allowed" disabled>
                  <i class="fa-solid fa-screwdriver-wrench"></i>
                  Acionar Manutenção
                </button>
                <p class="text-[0.65rem] text-slate-500">
                  Botão habilitado automaticamente quando o <span class="text-emerald-300">Zinco atinge o limite crítico</span> ou o
                  <span class="text-orange-300">dano em Aço ultrapassa o limite de alerta</span>.
                </p>
              </div>

              <!-- Gateway -->
              <div class="card p-4 space-y-2">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-[0.65rem] uppercase tracking-[0.2em] text-slate-500">Gateway Solar 4G</p>
                    <h3 class="text-sm font-semibold text-slate-100">Status do Campo</h3>
                  </div>
                  <div id="gwStatusPill" class="chip bg-emerald-900/40 border border-emerald-500/60 text-emerald-300 flex items-center gap-1">
                    <span class="badge-dot bg-emerald-400 pulse"></span>Online
                  </div>
                </div>
                <div class="grid grid-cols-3 gap-3 text-xs text-slate-300">
                  <div>
                    <p class="text-slate-400">Sinal LoRaWAN</p>
                    <p id="gwSignalLabel" class="font-semibold text-sky-300">-- dBm</p>
                  </div>
                  <div>
                    <p class="text-slate-400">Bateria Gateway</p>
                    <p id="gwBatteryLabel" class="font-semibold text-emerald-300">--%</p>
                  </div>
                  <div>
                    <p class="text-slate-400">Última Comunicação</p>
                    <p id="gwLastSeen" class="font-semibold text-slate-200">agora</p>
                  </div>
                </div>
              </div>

              <!-- Custo evitado -->
              <div class="card p-4 space-y-2">
                <p class="text-[0.65rem] uppercase tracking-[0.2em] text-slate-500">Impacto Financeiro Estimado</p>
                <div class="flex items-end justify-between">
                  <div>
                    <p class="text-xs text-slate-400">Custos de falhas evitados (simulação)</p>
                    <p id="costLabel" class="text-xl font-bold text-emerald-400">R$ 0</p>
                  </div>
                  <div class="w-28 h-2 bg-slate-900 rounded-full overflow-hidden">
                    <div id="costBar" class="h-2 rounded-full bg-gradient-to-r from-emerald-400 to-amber-400" style="width:0%"></div>
                  </div>
                </div>
                <p class="text-[0.65rem] text-slate-500">
                  Estimativa baseada em inspeções evitadas e substituições de estrutura não realizadas (modelo fictício para uso acadêmico).
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- PAGE: RELATÓRIOS -->
        <section id="page-reports" class="page-section space-y-4">
          <div class="card p-4">
            <h2 class="text-lg font-semibold mb-1">Relatórios Operacionais</h2>
            <p class="text-sm text-slate-400 mb-4">
              Gere relatórios em PDF ou exporte dados em CSV com base no site e na simulação atual.
            </p>
            <div class="flex flex-wrap gap-3">
              <button id="btnPdf" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold flex items-center gap-2">
                <i class="fa-solid fa-file-pdf"></i>
                Gerar PDF (Resumo do Site)
              </button>
              <button id="btnCsv" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm font-semibold flex items-center gap-2">
                <i class="fa-solid fa-file-csv"></i>
                Exportar CSV (Simulação)
              </button>
            </div>
          </div>
        </section>

        <!-- PAGE: CADASTRO -->
        <section id="page-register" class="page-section space-y-4">
          <div class="card p-4 max-w-xl">
            <h2 class="text-lg font-semibold mb-1">Cadastro de Novo Site</h2>
            <p class="text-sm text-slate-400 mb-4">
              Adicione um novo local ao parque monitorado. Os dados são usados apenas na simulação local (não há backend real).
            </p>
            <form id="formRegister" class="space-y-3 text-sm">
              <div>
                <label class="block text-slate-300 mb-1">ID do Site</label>
                <input id="newId" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="EV-XX-00" required />
              </div>
              <div>
                <label class="block text-slate-300 mb-1">Nome</label>
                <input id="newName" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Descrição do local" required />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-slate-300 mb-1">Distância da orla (km)</label>
                  <input id="newDist" type="number" step="0.1" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="0.5" required />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Fator ambiente (ISO)</label>
                  <input id="newFactor" type="number" step="0.1" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="1.5" required />
                </div>
              </div>
              <button type="submit" class="mt-2 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-sm font-semibold flex items-center gap-2">
                <i class="fa-solid fa-save"></i>
                Salvar Site
              </button>
            </form>
          </div>
        </section>

        <!-- PAGE: MAPA (conceitual) -->
        <section id="page-map" class="page-section space-y-4">
          <div class="card p-4">
            <div class="flex justify-between items-center mb-3">
              <div>
                <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500">Localização do Ativo</p>
                <h2 class="text-lg font-semibold text-slate-100">Mapa Operacional (conceitual)</h2>
              </div>
              <span class="chip bg-slate-900/80 border border-slate-700 text-slate-300 flex items-center gap-1">
                <i class="fa-solid fa-location-dot text-amber-300"></i>
                Mapa
              </span>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mt-2">
              <!-- Área visual do mapa (mock) -->
              <div class="md:col-span-2 rounded-xl bg-gradient-to-br from-slate-900 via-slate-900 to-slate-800 border border-slate-700 flex items-center justify-center">
                <div class="text-center text-slate-400 text-sm px-4 py-8">
                  <i class="fa-solid fa-map-location-dot text-3xl text-blue-400 mb-3"></i>
                  <p>Visualização conceitual do site selecionado.</p>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Em produção, aqui integraríamos com Google Maps / Leaflet usando as coordenadas reais do ativo.
                  </p>
                </div>
              </div>

              <!-- Detalhes do ativo -->
              <div class="space-y-3 text-xs text-slate-300">
                <div>
                  <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Ativo</p>
                  <p id="mapSite" class="text-sm font-semibold text-slate-100">--</p>
                </div>
                <div>
                  <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Endereço (referência)</p>
                  <p id="mapAddress" class="text-[0.80rem] text-slate-300">--</p>
                </div>
                <div>
                  <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Região</p>
                  <p id="mapRegion" class="text-[0.80rem] text-slate-300">--</p>
                </div>
                <div>
                  <p class="text-[0.65rem] uppercase tracking-[0.20em] text-slate-500 mb-1">Condições Ambientais</p>
                  <p id="mapEnv" class="text-[0.80rem] text-slate-300">--</p>
                </div>
                <div id="mapSummary" class="mt-2 grid gap-2 text-[0.78rem]"></div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">
    <i class="fa-solid fa-circle-check text-emerald-400"></i>
    <span id="toastMsg">OK</span>
  </div>

  <script>
    const sites = [
      {
        id: 'EV-BA-01',
        name: 'Salvador – Orla Atlântica',
        distKm: 0.2,
        envFactor: 1.7,
        region: 'NE',
        city: 'Salvador/BA',
        address: 'Orla Atlântica – Ponto Técnico 01',
        humidity: 78,
        wind: 16,
        sensorCu: 15,
        battery: 92,
        plateDamage: 18,
        zinc: 25,
        steel: 0,
        costSaved: 5,
        gwBattery: 97,
        gwSignal: -80
      },
      {
        id: 'EV-RJ-04',
        name: 'Rio de Janeiro – Litoral Sul',
        distKm: 0.5,
        envFactor: 1.6,
        region: 'SE',
        city: 'Rio de Janeiro/RJ',
        address: 'Zona Sul – Ponto Técnico 04',
        humidity: 75,
        wind: 18,
        sensorCu: 18,
        battery: 88,
        plateDamage: 22,
        zinc: 30,
        steel: 2,
        costSaved: 8,
        gwBattery: 94,
        gwSignal: -78
      },
      {
        id: 'EV-PE-08',
        name: 'Recife – Boa Viagem',
        distKm: 0.3,
        envFactor: 1.5,
        region: 'NE',
        city: 'Recife/PE',
        address: 'Boa Viagem – Ponto Técnico 08',
        humidity: 82,
        wind: 15,
        sensorCu: 12,
        battery: 95,
        plateDamage: 10,
        zinc: 20,
        steel: 0,
        costSaved: 3,
        gwBattery: 99,
        gwSignal: -79
      }
    ];

    const THRESHOLDS = {
      zincCritical: 100,
      zincAttention: 70,
      steelCritical: 30,
      steelAttention: 15
    };

    const RISK_LEVELS = {
      moderate: 60,
      high: 90,
      critical: 130
    };

    const SCENARIOS = {
      default: {
        label: 'Padrão',
        corrosionMultiplier: 1.0,
        humidityDrift: 0,
        windDrift: 0
      },
      coastal: {
        label: 'Costeiro Severo',
        corrosionMultiplier: 1.6,
        humidityDrift: 4,
        windDrift: 3
      },
      urban: {
        label: 'Urbano Costeiro',
        corrosionMultiplier: 1.2,
        humidityDrift: 2,
        windDrift: 1
      },
      inland: {
        label: 'Interior Seco',
        corrosionMultiplier: 0.7,
        humidityDrift: -4,
        windDrift: -1
      }
    };

    let currentScenario = 'default';
    let currentIndex = 0;
    let mainChart = null;
    let simInterval = null;
    let eventTimeline = [];
    const MAX_EVENTS = 15;
    let stepsCounter = 0;
    let lastGwSeenSeconds = 0;

    function isoCategory(f) {
      if (f >= 1.6) return 'C5-M (Muito Alta)';
      if (f >= 1.3) return 'C4 (Alta)';
      if (f >= 1.0) return 'C3 (Média)';
      return 'C2 (Moderada)';
    }

    function calcIIS(site) {
      const zincImpact = Math.min(site.zinc, 120) / 120;
      const steelImpact = site.steel / 100;
      const envImpact = site.envFactor / 2;
      const plateImpact = site.plateDamage / 100;
      let score = 100 - (zincImpact * 35 + steelImpact * 40 + envImpact * 15 + plateImpact * 10);
      if (score < 0) score = 0;
      if (score > 100) score = 100;
      return score;
    }

    function formatBRL(thousands) {
      const v = thousands * 1000;
      return v.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        maximumFractionDigits: 0
      });
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      const span = document.getElementById('toastMsg');
      span.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    function addEvent(level, title, desc) {
      const now = new Date();
      const ts = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      eventTimeline.unshift({ ts, level, title, desc });
      if (eventTimeline.length > MAX_EVENTS) {
        eventTimeline.pop();
      }
      renderTimeline();
    }

    function renderTimeline() {
      const container = document.getElementById('timelineList');
      if (!container) return;
      container.innerHTML = '';
      eventTimeline.forEach(ev => {
        let colorClass = 'text-slate-200';
        if (ev.level === 'info') colorClass = 'text-sky-300';
        else if (ev.level === 'warn') colorClass = 'text-amber-300';
        else if (ev.level === 'critical') colorClass = 'text-red-400';
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-start gap-2 mb-1.5';
        wrapper.innerHTML =
          '<span class="text-[0.65rem] text-slate-500 w-10 shrink-0">' + ev.ts + '</span>' +
          '<div class="flex-1">' +
            '<p class="text-[0.75rem] ' + colorClass + '">' + ev.title + '</p>' +
            '<p class="text-[0.70rem] text-slate-400">' + ev.desc + '</p>' +
          '</div>';
        container.appendChild(wrapper);
      });
    }

    function updateEnvWidgets(site) {
      document.getElementById('regionLabel').textContent =
        site.region + ' • ' + site.city;
      document.getElementById('humidityLabel').textContent =
        site.humidity.toFixed(0) + '%';
      document.getElementById('windLabel').textContent =
        site.wind.toFixed(1) + ' km/h';

      document.getElementById('mapSite').textContent =
        site.id + ' — ' + site.name;
      document.getElementById('mapAddress').textContent = site.address;
      document.getElementById('mapRegion').textContent =
        site.region + ' • ' + site.city;
      document.getElementById('mapEnv').textContent =
        'Umidade ' + site.humidity.toFixed(0) +
        '% • Vento ' + site.wind.toFixed(1) + ' km/h';
    }

    function updateHeader(site) {
      document.getElementById('siteTitle').textContent = site.id + ' — ' + site.name;
      document.getElementById('siteSubtitle').textContent =
        site.distKm.toFixed(1) + ' km da orla • Fator ' + site.envFactor.toFixed(2) + 'x';
      const iso = isoCategory(site.envFactor);
      document.getElementById('isoLabel').textContent = iso;
      document.getElementById('isoText').textContent = iso;
      const remaining = Math.max(0, THRESHOLDS.zincCritical - site.zinc);
      const days = Math.round(remaining * (site.envFactor > 1 ? 1.2 : 1.6));
      document.getElementById('rulLabel').textContent = days + ' dias';

      const iis = calcIIS(site);
      const iisLabel = document.getElementById('iisLabel');
      iisLabel.textContent = iis.toFixed(0) + '/100';
      if (iis >= 80) {
        iisLabel.className = 'text-2xl font-bold text-emerald-400';
      } else if (iis >= 50) {
        iisLabel.className = 'text-2xl font-bold text-amber-300';
      } else {
        iisLabel.className = 'text-2xl font-bold text-red-400';
      }

      updateEnvWidgets(site);
      updateMapSummary();
    }

    function updateTEF(site) {
      const sc = SCENARIOS[currentScenario] || SCENARIOS.default;
      const factor = site.envFactor * sc.corrosionMultiplier;

      function formatDays(d) {
        if (d <= 1) return '≤ 1 dia';
        if (d < 60) return Math.round(d) + ' dias';
        const months = d / 30;
        return months.toFixed(1).replace('.', ',') + ' meses';
      }

      const rateCu = Math.max(0.1, factor * 0.8);
      const rateZinc = Math.max(0.1, factor * 0.6);
      const rateSteel = Math.max(0.05, factor * 0.18);

      const dCu = site.plateDamage >= 100 ? 0 : (100 - site.plateDamage) / rateCu;
      const dZn = site.zinc >= THRESHOLDS.zincCritical ? 0 : (THRESHOLDS.zincCritical - site.zinc) / rateZinc;
      const targetSteel = THRESHOLDS.steelCritical;
      const dSt = site.steel >= targetSteel ? 0 : (targetSteel - site.steel) / rateSteel;

      document.getElementById('tefCu').textContent = formatDays(dCu);
      document.getElementById('tefZinc').textContent = formatDays(dZn);
      document.getElementById('tefSteel').textContent = formatDays(dSt);
    }

    function updateGatewayCard(site) {
      const statusPill = document.getElementById('gwStatusPill');
      const signalEl = document.getElementById('gwSignalLabel');
      const battEl = document.getElementById('gwBatteryLabel');
      const lastSeenEl = document.getElementById('gwLastSeen');

      signalEl.textContent = site.gwSignal.toFixed(0) + ' dBm';
      battEl.textContent = site.gwBattery.toFixed(0) + '%';

      if (lastGwSeenSeconds < 30) {
        statusPill.className = 'chip bg-emerald-900/40 border border-emerald-500/60 text-emerald-300 flex items-center gap-1';
        statusPill.innerHTML = '<span class="badge-dot bg-emerald-400 pulse"></span>Online';
        lastSeenEl.textContent = 'há poucos segundos';
      } else if (lastGwSeenSeconds < 180) {
        statusPill.className = 'chip bg-amber-900/40 border border-amber-400/60 text-amber-200 flex items-center gap-1';
        statusPill.innerHTML = '<span class="badge-dot bg-amber-400"></span>Intermitente';
        lastSeenEl.textContent = 'há ' + Math.round(lastGwSeenSeconds / 60) + ' min';
      } else {
        statusPill.className = 'chip bg-red-900/40 border border-red-500/60 text-red-300 flex items-center gap-1';
        statusPill.innerHTML = '<span class="badge-dot bg-red-500"></span>Offline';
        lastSeenEl.textContent = 'há ' + Math.round(lastGwSeenSeconds / 60) + ' min';
      }
    }

    function updateSensorCards(site) {
      document.getElementById('cuValueLabel').textContent = site.sensorCu.toFixed(2) + ' mV';
      document.getElementById('cuBatteryLabel').textContent = site.battery.toFixed(0) + '%';
      document.getElementById('cuBatteryBar').style.width = Math.min(100, site.battery) + '%';
      const days = Math.max(1, Math.round(site.battery * 0.4));
      document.getElementById('cuBatteryLife').textContent = '~ ' + days + ' dias restantes';

      document.getElementById('cuDamageLabel').textContent = site.plateDamage.toFixed(1) + '%';
      document.getElementById('cuDamageBar').style.width = Math.min(100, site.plateDamage) + '%';
      const remainingLife = Math.max(0, 100 - site.plateDamage);
      document.getElementById('cuDamageLife').textContent = 'Vida restante: ' + remainingLife.toFixed(0) + '%';

      document.getElementById('zincLevelLabel').textContent = site.zinc.toFixed(1) + '%';
      document.getElementById('zincBar').style.width = Math.min(100, site.zinc) + '%';

      document.getElementById('steelLevelLabel').textContent = site.steel.toFixed(1) + '%';
      const steelRatio = Math.min(100, (site.steel / THRESHOLDS.steelCritical) * 100);
      document.getElementById('steelBar').style.width = steelRatio + '%';

      document.getElementById('costLabel').textContent = formatBRL(site.costSaved);
      document.getElementById('costBar').style.width = Math.min(100, site.costSaved * 3) + '%';

      updateMaintenance(site);
      updateTEF(site);
      updateGatewayCard(site);
    }

    function updateMaintenance(site) {
      const badge = document.getElementById('maintBadge');
      const text = document.getElementById('maintText');
      const btn = document.getElementById('btnMaint');

      const zincCritical = site.zinc >= THRESHOLDS.zincCritical;
      const steelCritical = site.steel >= THRESHOLDS.steelCritical;

      if (zincCritical || steelCritical) {
        badge.className = 'chip bg-red-900/50 border border-red-500/60 text-red-300 flex items-center gap-1';
        badge.innerHTML = '<span class="badge-dot bg-red-500 pulse"></span>Crítico';
        text.textContent = 'Recomenda-se intervenção imediata: proteção de zinco esgotada e/ou dano estrutural elevado.';
        btn.disabled = false;
      } else if (site.zinc >= THRESHOLDS.zincAttention || site.steel >= THRESHOLDS.steelAttention) {
        badge.className = 'chip bg-amber-900/40 border border-amber-400/70 text-amber-200 flex items-center gap-1';
        badge.innerHTML = '<span class="badge-dot bg-amber-400"></span>Atenção';
        text.textContent = 'Janela ideal para programar manutenção preventiva antes do limite crítico.';
        btn.disabled = false;
      } else {
        badge.className = 'chip bg-emerald-900/40 border border-emerald-500/40 text-emerald-300 flex items-center gap-1';
        badge.innerHTML = '<span class="badge-dot bg-emerald-400 pulse"></span>Saudável';
        text.textContent = 'Nenhum limite crítico atingido para o site atual. Sistema em monitoramento contínuo.';
        btn.disabled = true;
      }
    }

    function riskScore(site) {
      return site.zinc * 0.7 + site.steel * 1.4 + site.envFactor * 10 + site.plateDamage * 0.5;
    }

    function refreshRiskTable() {
      const body = document.getElementById('riskTableBody');
      body.innerHTML = '';
      const sorted = [].concat(sites).sort(function(a, b) {
        return riskScore(b) - riskScore(a);
      });
      sorted.forEach(function(s) {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-800/60 last:border-0';
        const r = riskScore(s);
        let tag = 'Baixo';
        let cls = 'text-emerald-400';
        if (r > RISK_LEVELS.critical) { tag = 'Crítico'; cls = 'text-red-400'; }
        else if (r > RISK_LEVELS.high) { tag = 'Alto'; cls = 'text-orange-400'; }
        else if (r > RISK_LEVELS.moderate) { tag = 'Moderado'; cls = 'text-yellow-300'; }

        tr.innerHTML =
          '<td class="py-1 text-left text-[0.72rem]">' +
            '<span class="font-semibold mr-1 text-slate-100">' + s.id + '</span>' +
            '<span class="text-slate-400">' + s.name.split('–')[0].trim() + '</span>' +
          '</td>' +
          '<td class="py-1 text-right text-[0.72rem]">' + s.zinc.toFixed(1) + '%</td>' +
          '<td class="py-1 text-right text-[0.72rem]">' + s.steel.toFixed(1) + '%</td>' +
          '<td class="py-1 text-right text-[0.72rem]">' +
            '<span class="' + cls + ' font-semibold">' + tag + '</span>' +
          '</td>';
        body.appendChild(tr);
      });
      updateMapSummary();
    }

    function updateMapSummary() {
      const container = document.getElementById('mapSummary');
      if (!container) return;

      const riskCounts = { 'Baixo': 0, 'Moderado': 0, 'Alto': 0, 'Crítico': 0 };
      const regionCounts = {};

      for (let i = 0; i < sites.length; i++) {
        const s = sites[i];
        const score = riskScore(s);
        let tag = 'Baixo';
        if (score > RISK_LEVELS.critical) tag = 'Crítico';
        else if (score > RISK_LEVELS.high) tag = 'Alto';
        else if (score > RISK_LEVELS.moderate) tag = 'Moderado';
        riskCounts[tag] = (riskCounts[tag] || 0) + 1;
        regionCounts[s.region] = (regionCounts[s.region] || 0) + 1;
      }

      let regionHtml = '';
      for (const key in regionCounts) {
        if (Object.prototype.hasOwnProperty.call(regionCounts, key)) {
          regionHtml += '<p><span class="text-sky-300 font-semibold">' + key + ':</span> ' +
                        regionCounts[key] + ' site(s)</p>';
        }
      }

      container.innerHTML =
        '<div class="bg-slate-900/80 rounded-lg p-3 border border-slate-700/70">' +
          '<p class="text-[0.65rem] uppercase tracking-[0.18em] text-slate-500 mb-1">Distribuição por risco</p>' +
          '<div class="space-y-1 text-[0.75rem]">' +
            '<p><span class="text-emerald-400 font-semibold">Baixo:</span> ' + (riskCounts['Baixo'] || 0) + ' site(s)</p>' +
            '<p><span class="text-yellow-300 font-semibold">Moderado:</span> ' + (riskCounts['Moderado'] || 0) + ' site(s)</p>' +
            '<p><span class="text-orange-400 font-semibold">Alto:</span> ' + (riskCounts['Alto'] || 0) + ' site(s)</p>' +
            '<p><span class="text-red-400 font-semibold">Crítico:</span> ' + (riskCounts['Crítico'] || 0) + ' site(s)</p>' +
          '</div>' +
        '</div>' +
        '<div class="bg-slate-900/80 rounded-lg p-3 border border-slate-700/70">' +
          '<p class="text-[0.65rem] uppercase tracking-[0.18em] text-slate-500 mb-1">Distribuição por região</p>' +
          '<div class="space-y-1 text-[0.75rem]">' +
            regionHtml +
          '</div>' +
        '</div>';
    }

    function initChart() {
      const ctx = document.getElementById('mainChart').getContext('2d');
      mainChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: new Array(40).fill(''),
          datasets: [
            { label: 'Cu', data: new Array(40).fill(0), borderColor: '#38bdf8', borderWidth: 2, tension: 0.25, pointRadius: 0 },
            { label: 'Zinco', data: new Array(40).fill(0), borderColor: '#22c55e', borderWidth: 2, tension: 0.25, pointRadius: 0 },
            { label: 'Aço', data: new Array(40).fill(0), borderColor: '#fb923c', borderWidth: 2, tension: 0.25, pointRadius: 0 }
          ]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: {
              beginAtZero: true,
              ticks: { color: '#9ca3af', font: { size: 10 } },
              grid: { color: 'rgba(55,65,81,0.6)' }
            }
          }
        }
      });
    }

    function pushChartPoint(site) {
      if (!mainChart) return;
      const d = mainChart.data.datasets;
      d[0].data.push(site.sensorCu);
      d[1].data.push(site.zinc);
      d[2].data.push(site.steel);
      d.forEach(function(ds) { ds.data.shift(); });
      mainChart.update('none');
    }

    function stepSimulation() {
      const site = sites[currentIndex];
      const sc = SCENARIOS[currentScenario] || SCENARIOS.default;
      const base = site.envFactor * sc.corrosionMultiplier;

      const prevZ = site.zinc;
      const prevS = site.steel;
      const prevPlate = site.plateDamage;

      const deltaCu = (Math.random() * 0.8 + 0.2) * base;
      site.sensorCu += deltaCu;
      const deltaZinc = deltaCu * 0.5;
      site.zinc = Math.min(120, site.zinc + deltaZinc);
      const deltaPlate = deltaCu * 0.4;
      site.plateDamage = Math.min(100, site.plateDamage + deltaPlate);

      if (site.zinc > 80) {
        const deltaSteel = (site.zinc - 80) * 0.02 * base;
        site.steel = Math.min(100, site.steel + deltaSteel);
      }

      const deltaBat = 0.03 * base;
      site.battery = Math.max(0, site.battery - deltaBat);

      site.costSaved += 0.06 * base;

      site.humidity = Math.min(98, Math.max(45, site.humidity + (Math.random() * 4 - 2 + sc.humidityDrift * 0.05)));
      site.wind = Math.min(40, Math.max(0, site.wind + (Math.random() * 3 - 1.5 + sc.windDrift * 0.05)));

      site.gwBattery = Math.max(40, Math.min(100, site.gwBattery - (Math.random() * 0.02)));
      site.gwSignal = Math.max(-105, Math.min(-60, site.gwSignal + (Math.random() * 4 - 2)));

      lastGwSeenSeconds = 0;

      if (prevZ < THRESHOLDS.zincAttention && site.zinc >= THRESHOLDS.zincAttention && site.zinc < THRESHOLDS.zincCritical) {
        addEvent('warn', 'Zinco em atenção (' + site.id + ')', 'Proteção de zinco entrou em faixa de atenção para o site ' + site.id + '.');
      }
      if (prevZ < THRESHOLDS.zincCritical && site.zinc >= THRESHOLDS.zincCritical) {
        addEvent('critical', 'Zinco esgotado (' + site.id + ')', 'Proteção de zinco atingiu limite crítico para o site ' + site.id + '.');
      }
      if (prevS < THRESHOLDS.steelAttention && site.steel >= THRESHOLDS.steelAttention && site.steel < THRESHOLDS.steelCritical) {
        addEvent('warn', 'Dano em aço em atenção (' + site.id + ')', 'Degradação estrutural entrou em zona de atenção.');
      }
      if (prevS < THRESHOLDS.steelCritical && site.steel >= THRESHOLDS.steelCritical) {
        addEvent('critical', 'Dano estrutural crítico (' + site.id + ')', 'Dano em aço acima do limite crítico para o site ' + site.id + '.');
      }
      if (prevPlate < 50 && site.plateDamage >= 50) {
        addEvent('warn', 'Placa sacrificial degradada', 'Placa de sacrifício ultrapassou 50% de dano no site ' + site.id + '.');
      }

      stepsCounter++;
      if (stepsCounter % 15 === 0) {
        addEvent('info', 'Stream saudável', 'Gateway reportando dados de corrosão de forma contínua.');
      }

      updateHeader(site);
      updateSensorCards(site);
      refreshRiskTable();
      pushChartPoint(site);
    }

    function showPage(name) {
      const sections = document.querySelectorAll('.page-section');
      for (let i = 0; i < sections.length; i++) {
        sections[i].classList.remove('active');
      }
      const page = document.getElementById('page-' + name);
      if (page) page.classList.add('active');

      const buttons = document.querySelectorAll('[data-page-target]');
      for (let j = 0; j < buttons.length; j++) {
        buttons[j].classList.remove('sidebar-item-active');
      }
      const activeBtn = document.querySelector('[data-page-target="' + name + '"]');
      if (activeBtn) activeBtn.classList.add('sidebar-item-active');
    }

    function exportPdf() {
      const site = sites[currentIndex];
      const iis = calcIIS(site);
      const sc = SCENARIOS[currentScenario] || SCENARIOS.default;

      const jsPDF = window.jspdf.jsPDF;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('Relatório TowerGuard - Site ' + site.id, 14, 20);
      doc.setFontSize(11);
      doc.text('Nome: ' + site.name, 14, 32);
      doc.text('Distância da orla: ' + site.distKm.toFixed(1) + ' km', 14, 40);
      doc.text('Fator ISO: ' + site.envFactor.toFixed(2) + ' (' + isoCategory(site.envFactor) + ')', 14, 48);
      doc.text('Cenário: ' + sc.label, 14, 56);
      doc.text('Índice de Integridade: ' + iis.toFixed(0) + '/100', 14, 64);

      doc.text('Sensor Cu: ' + site.sensorCu.toFixed(2) + ' mV', 14, 76);
      doc.text('Bateria Sensor: ' + site.battery.toFixed(0) + '%', 14, 84);
      doc.text('Dano Placa: ' + site.plateDamage.toFixed(1) + '%', 14, 92);
      doc.text('Zinco: ' + site.zinc.toFixed(1) + '%', 14, 100);
      doc.text('Aço: ' + site.steel.toFixed(1) + '%', 14, 108);

      doc.text('Região: ' + site.region + ' • ' + site.city, 14, 120);
      doc.text('Umidade: ' + site.humidity.toFixed(0) + ' %', 14, 128);
      doc.text('Vento: ' + site.wind.toFixed(1) + ' km/h', 14, 136);

      doc.text('Gateway: sinal ' + site.gwSignal.toFixed(0) + ' dBm, bateria ' + site.gwBattery.toFixed(0) + '%', 14, 148);

      doc.save('towerguard_' + site.id + '.pdf');
    }

    function exportCsv() {
      const site = sites[currentIndex];
      const rows = [
        ['campo', 'valor'],
        ['site_id', site.id],
        ['nome', site.name],
        ['dist_km', site.distKm],
        ['fator_iso', site.envFactor],
        ['sensor_cu_mv', site.sensorCu],
        ['bateria_pct', site.battery],
        ['dano_placa_pct', site.plateDamage],
        ['zinco_pct', site.zinc],
        ['aco_pct', site.steel],
        ['regiao', site.region],
        ['cidade', site.city],
        ['umidade_pct', site.humidity],
        ['vento_kmh', site.wind],
        ['gw_signal_dbm', site.gwSignal],
        ['gw_bateria_pct', site.gwBattery]
      ];
      let csv = '';
      for (let i = 0; i < rows.length; i++) {
        csv += rows[i].join(';') + '\n';
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'towerguard_' + site.id + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function initSiteSelect() {
      const sel = document.getElementById('siteSelect');
      for (let i = 0; i < sites.length; i++) {
        const s = sites[i];
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = s.id + ' — ' + s.name;
        sel.appendChild(opt);
      }

      const savedIndex = localStorage.getItem('tg.currentSiteIndex');
      let initialIndex = 0;
      if (savedIndex !== null) {
        const parsed = parseInt(savedIndex, 10);
        if (!isNaN(parsed) && parsed >= 0 && parsed < sites.length) {
          initialIndex = parsed;
        }
      }

      currentIndex = initialIndex;
      sel.value = String(initialIndex);

      sel.addEventListener('change', function() {
        currentIndex = parseInt(sel.value, 10);
        if (isNaN(currentIndex) || currentIndex < 0 || currentIndex >= sites.length) {
          currentIndex = 0;
        }
        localStorage.setItem('tg.currentSiteIndex', String(currentIndex));
        const site = sites[currentIndex];
        updateHeader(site);
        updateSensorCards(site);
        refreshRiskTable();
        if (mainChart) {
          for (let i = 0; i < mainChart.data.datasets.length; i++) {
            mainChart.data.datasets[i].data = new Array(40).fill(0);
          }
          mainChart.update();
        }
        addEvent('info', 'Site alterado', 'Operador selecionou ' + site.id + ' — ' + site.name + '.');
        showToast('Site alterado para ' + site.id);
      });
    }

    function initClock() {
      const lbl = document.getElementById('clockLabel');
      function tick() {
        const d = new Date();
        lbl.textContent = d.toLocaleTimeString('pt-BR');
        lastGwSeenSeconds += 1;
        const site = sites[currentIndex];
        updateGatewayCard(site);
      }
      tick();
      setInterval(tick, 1000);
    }

    function initSidebarNav() {
      const buttons = document.querySelectorAll('[data-page-target]');
      for (let i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', function() {
          const target = buttons[i].getAttribute('data-page-target');
          showPage(target);
        });
      }
    }

    function initButtons() {
      const btnSim = document.getElementById('btnSim');
      const btnPresent = document.getElementById('btnPresent');
      const btnMaint = document.getElementById('btnMaint');
      const btnPdf = document.getElementById('btnPdf');
      const btnCsv = document.getElementById('btnCsv');
      const btnLogout = document.getElementById('btnLogout');
      const connText = document.getElementById('connText');

      btnSim.addEventListener('click', function() {
        if (simInterval) {
          clearInterval(simInterval);
          simInterval = null;
          btnSim.textContent = 'Iniciar Simulação';
          connText.textContent = 'Gateway Online (sem avanço)';
          addEvent('info', 'Simulação pausada', 'Fluxo de dados de corrosão pausado para análise.');
          showToast('Simulação pausada');
        } else {
          simInterval = setInterval(stepSimulation, 1200);
          btnSim.textContent = 'Pausar Simulação';
          connText.textContent = 'Gateway Online – stream de dados ativo';
          addEvent('info', 'Simulação iniciada', 'Fluxo de dados de corrosão em tempo real (simulado).');
          showToast('Simulação iniciada');
        }
      });

      btnPresent.addEventListener('click', function() {
        if (simInterval) clearInterval(simInterval);
        simInterval = setInterval(stepSimulation, 400);
        btnSim.textContent = 'Pausar Simulação';
        connText.textContent = 'Modo executivo – avanço acelerado';
        addEvent('info', 'Modo Executivo', 'Dashboard em modo executivo por 20 segundos para apresentação.');
        showToast('Modo Executivo por 20 segundos');
        setTimeout(function() {
          if (simInterval) {
            clearInterval(simInterval);
            simInterval = setInterval(stepSimulation, 1200);
            connText.textContent = 'Gateway Online – stream de dados ativo';
          }
        }, 20000);
      });

      btnMaint.addEventListener('click', function() {
        const site = sites[currentIndex];
        addEvent('info', 'Manutenção acionada', 'Ordem de manutenção emitida para ' + site.id + '.');
        showToast('Ordem de manutenção emitida para ' + site.id);
      });

      if (btnPdf) {
        btnPdf.addEventListener('click', function() {
          exportPdf();
          showToast('PDF gerado para o site atual');
        });
      }

      if (btnCsv) {
        btnCsv.addEventListener('click', function() {
          exportCsv();
          showToast('CSV exportado para o site atual');
        });
      }

      btnLogout.addEventListener('click', function() {
        addEvent('info', 'Logout simulado', 'Sessão do operador encerrada (apenas front-end).');
        showToast('Logout simulado. (Somente front-end)');
      });
    }

    function initRegisterForm() {
      const form = document.getElementById('formRegister');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('newId').value.trim().toUpperCase();
        const name = document.getElementById('newName').value.trim();
        const dist = parseFloat(document.getElementById('newDist').value);
        const factor = parseFloat(document.getElementById('newFactor').value);
        if (!id || !name || isNaN(dist) || isNaN(factor)) {
          showToast('Preencha todos os campos corretamente.');
          return;
        }
        sites.push({
          id: id,
          name: name,
          distKm: dist,
          envFactor: factor,
          region: 'ND',
          city: 'Novo Site',
          address: 'Endereço a definir',
          humidity: 70,
          wind: 10,
          sensorCu: 10,
          battery: 100,
          plateDamage: 0,
          zinc: 10,
          steel: 0,
          costSaved: 0,
          gwBattery: 100,
          gwSignal: -80
        });
        const sel = document.getElementById('siteSelect');
        const idx = sites.length - 1;
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = id + ' — ' + name;
        sel.appendChild(opt);
        sel.value = String(idx);
        sel.dispatchEvent(new Event('change'));
        form.reset();
        addEvent('info', 'Novo site cadastrado', 'Site ' + id + ' incluído na simulação.');
        showToast('Novo site cadastrado na simulação.');
      });
    }

    function initScenarioSelect() {
      const sel = document.getElementById('scenarioSelect');
      sel.addEventListener('change', function() {
        currentScenario = sel.value;
        const sc = SCENARIOS[currentScenario] || SCENARIOS.default;
        const site = sites[currentIndex];
        addEvent('info', 'Cenário atualizado', 'Novo cenário: ' + sc.label + '.');
        updateHeader(site);
        updateSensorCards(site);
        refreshRiskTable();
        showToast('Cenário alterado para ' + sc.label);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      initSiteSelect();
      initClock();
      initSidebarNav();
      initButtons();
      initRegisterForm();
      initScenarioSelect();
      initChart();

      const site = sites[currentIndex];
      updateHeader(site);
      updateSensorCards(site);
      refreshRiskTable();

      for (let i = 0; i < 10; i++) {
        stepSimulation();
      }

      addEvent('info', 'Monitoramento iniciado', 'Simulação local do parque TowerGuard carregada.');
    });
  </script>
</body>
</html>
